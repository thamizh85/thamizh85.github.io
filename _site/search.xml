<?xml version="1.0" encoding="utf-8"?>
<search>
  
    <entry>
      <title><![CDATA[Predicting the playing role of a cricketer using Machine Learning (Part 2)]]></title>
      <url>/machine%20learning/2018/04/28/2018-04-28-predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/</url>
      <content type="html"><![CDATA[<p>In the previous <a href="https://thamizh85.github.io/machine%20learning/2018/04/23/2018-04-23-predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-1/">post</a> we saw how to scrape raw data from a content rich webpage. In this post, we will explore how to process that raw data and use Machine Learning tools to predict the playing role of a cricket player just based on his career statistics.</p>

<p>Here are the tools that we will use for this exercise. For interactive data analysis and number crunching:</p>
<ol>
  <li>Jupyter</li>
  <li>Pandas</li>
  <li>Numpy</li>
</ol>

<p>For visualizing data:</p>
<ol>
  <li>Seaborn</li>
  <li>matplotlib</li>
</ol>

<p>For running Machine Learning models:</p>
<ol>
  <li>Tensorflow</li>
  <li>Keras</li>
  <li>Scikit-learn</li>
</ol>

<h2 id="importing-data">Importing data</h2>
<p>First let us load the necessary modules:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
</code></pre>
</div>

<p>Import the CSV file which we scraped as a pandas data frame and inspect its contents.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/players.csv'</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">dtypes</span>
</code></pre>
</div>

<table>
  <tbody>
    <tr>
      <td>Bat_100</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_4s</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_50</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_6s</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_Ave</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_BF</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_Ct</td>
      <td>int64</td>
    </tr>
    <tr>
      <td>Bat_HS</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_Inns</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_Mat</td>
      <td>int64</td>
    </tr>
    <tr>
      <td>Bat_NO</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_Runs</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_SR</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bat_St</td>
      <td>int64</td>
    </tr>
    <tr>
      <td>Bio_Also_known_as</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Batting_style</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Born</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Bowling_style</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Current_age</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Died</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Education</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Fielding_position</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Full_name</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Height</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_In_a_nutshell</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Major_teams</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Nickname</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Other</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Playing_role</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bio_Relation</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_10</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_4w</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_5w</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Ave</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_BBI</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_BBM</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Balls</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Econ</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Inns</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Mat</td>
      <td>int64</td>
    </tr>
    <tr>
      <td>Bowl_Runs</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_SR</td>
      <td>object</td>
    </tr>
    <tr>
      <td>Bowl_Wkts</td>
      <td>object</td>
    </tr>
    <tr>
      <td>dtype: object</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>We can see that most of the fields are decoded as <code class="highlighter-rouge">object</code> data type which is a generic pandas datatype. It gets assigned if our data consists of mixed types such as characters and numerals. There are some obvious numerical fields which are getting detected as string. But before we recast all of them as string, we need to preprocess some of them to extract numeric value out of them.</p>

<p>For example, let us inspect <code class="highlighter-rouge">Bowl_BBI</code> and <code class="highlighter-rouge">Bowl_BBM</code> which stands for best bowling figures in an innings and a match respectively.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="p">[[</span><span class="s">'Bowl_BBI'</span><span class="p">,</span><span class="s">'Bowl_BBM'</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>Bowl_BBI</th>
      <th>Bowl_BBM</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3/31</td>
      <td>3/31</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2/35</td>
      <td>2/42</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>8</td>
      <td>6/85</td>
      <td>8/58</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-</td>
      <td>-</td>
    </tr>
  </tbody>
</table>

<p>Either fields can be made sense as a combination of two independent variables- Best Bowling Wickets &amp; Best Bowling Runs. Similarly when we cast the field <code class="highlighter-rouge">Bat_HS</code> as integer, the notout values will be lost since they are suffixed with an asterisk which makes them a string data type. Let us go ahead to fix these potential issues.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Best bowling innings wickets</span>
<span class="n">bbi_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'Bowl_BBI'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'-'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                      <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bowl_BBIW'</span><span class="p">,</span><span class="s">'Bowl_BBIR'</span><span class="p">])</span>
<span class="n">bbm_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'Bowl_BBM'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'-'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                      <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bowl_BBMW'</span><span class="p">,</span><span class="s">'Bowl_BBMR'</span><span class="p">])</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">bbi_df</span><span class="p">,</span><span class="n">bbm_df</span><span class="p">])</span>

<span class="c"># Identify numeric columns</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bat_100'</span><span class="p">,</span><span class="s">'Bat_4s'</span><span class="p">,</span><span class="s">'Bat_50'</span><span class="p">,</span><span class="s">'Bat_6s'</span><span class="p">,</span><span class="s">'Bat_Ave'</span><span class="p">,</span><span class="s">'Bat_BF'</span><span class="p">,</span>
                <span class="s">'Bat_Ct'</span><span class="p">,</span><span class="s">'Bat_HS'</span><span class="p">,</span><span class="s">'Bat_Inns'</span><span class="p">,</span><span class="s">'Bat_Mat'</span><span class="p">,</span><span class="s">'Bat_NO'</span><span class="p">,</span><span class="s">'Bat_Runs'</span><span class="p">,</span>
                <span class="s">'Bat_SR'</span><span class="p">,</span><span class="s">'Bat_St'</span><span class="p">,</span><span class="s">'Bowl_10'</span><span class="p">,</span><span class="s">'Bowl_4w'</span><span class="p">,</span><span class="s">'Bowl_5w'</span><span class="p">,</span><span class="s">'Bowl_Ave'</span><span class="p">,</span>
                <span class="s">'Bowl_Balls'</span><span class="p">,</span><span class="s">'Bowl_Econ'</span><span class="p">,</span><span class="s">'Bowl_Inns'</span><span class="p">,</span><span class="s">'Bowl_Mat'</span><span class="p">,</span><span class="s">'Bowl_Runs'</span><span class="p">,</span>
                <span class="s">'Bowl_SR'</span><span class="p">,</span> <span class="s">'Bowl_Wkts'</span><span class="p">,</span><span class="s">'Bowl_BBIW'</span><span class="p">,</span><span class="s">'Bowl_BBIR'</span><span class="p">,</span><span class="s">'Bowl_BBMW'</span><span class="p">,</span><span class="s">'Bowl_BBMR'</span><span class="p">]</span>

<span class="c"># regex replace * in High scores</span>
<span class="n">data</span><span class="p">[</span><span class="s">'Bat_HS'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'Bat_HS'</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r'</span><span class="err">\</span><span class="s">*$'</span><span class="p">,</span><span class="s">''</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'-'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'coerce'</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</code></pre>
</div>
<p>If we check the data type again, we will see that all the numerical fields are interpreted as int or float datatype as expected.</p>

<blockquote>
  <p>Be careful when filling NaN with zeroes. Idea is not to introduce false values in to the dataset. In this case, a value of zero is neutral since it represents the same value as absent numbers. But for certain types of data, such as temperature, zero introduces a false value in to the data set since temperature values can be less than zero.</p>
</blockquote>

<h2 id="pre-processing">Pre-processing</h2>

<h3 id="deriving-new-features">Deriving new features</h3>

<p>When using data in our models we have to understand the units in which they are represented. Not all features are directly comparable. For instance, Average &amp; Strike rates are already averaged over the number of matches that a player plays. But other aggregate statistics aren’t. So in effect it would be meaningless to compare run tally of a player who has played only 10 matches with that of another who has played a hundred matches.</p>

<p>To understand better, let us plot runs scored vs the matches played.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"Bat_Runs"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"Bat_Inns"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre>
</div>
<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-inns-vs-bat-runs.png" alt="Bat Inns vs Bat Runs" /></p>

<p>Obviously there is a strong correlation between no. of matches played and no. of runs scored. Ideally we want our features to be as independent of each other as possible. To separate the influence of number of matches played on the batting runs feature, we will divide the aggregate statistics by number of matches played.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># select aggregate stats such as no. of hundreds, runs scored etc.,</span>
<span class="n">bat_features_raw</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bat_100'</span><span class="p">,</span> <span class="s">'Bat_4s'</span><span class="p">,</span> <span class="s">'Bat_50'</span><span class="p">,</span> <span class="s">'Bat_6s'</span><span class="p">,</span> 
                    <span class="s">'Bat_BF'</span><span class="p">,</span> <span class="s">'Bat_Ct'</span><span class="p">,</span> <span class="s">'Bat_NO'</span><span class="p">,</span> <span class="s">'Bat_Runs'</span><span class="p">,</span><span class="s">'Bat_St'</span><span class="p">]</span>

<span class="c"># column names for scaled features</span>
<span class="n">bat_features_scaled</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bat_100_sc'</span><span class="p">,</span> <span class="s">'Bat_4s_sc'</span><span class="p">,</span> <span class="s">'Bat_50_sc'</span><span class="p">,</span> <span class="s">'Bat_6s_sc'</span><span class="p">,</span> 
                    <span class="s">'Bat_BF_sc'</span><span class="p">,</span> <span class="s">'Bat_Ct_sc'</span><span class="p">,</span> <span class="s">'Bat_NO_sc'</span><span class="p">,</span> <span class="s">'Bat_Runs_sc'</span><span class="p">,</span><span class="s">'Bat_St_sc'</span><span class="p">]</span>

<span class="c"># leave aside match and innings count and other aggregate stats such as best bowling figures, strike rate and average</span>
<span class="n">bowl_features_raw</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bowl_10'</span><span class="p">,</span> <span class="s">'Bowl_4w'</span><span class="p">,</span> <span class="s">'Bowl_5w'</span><span class="p">,</span>  
                     <span class="s">'Bowl_Balls'</span><span class="p">,</span> <span class="s">'Bowl_Runs'</span><span class="p">,</span><span class="s">'Bowl_Wkts'</span><span class="p">]</span>

<span class="c"># column names for scaled features</span>
<span class="n">bowl_features_scaled</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bowl_10_sc'</span><span class="p">,</span> <span class="s">'Bowl_4w_sc'</span><span class="p">,</span> <span class="s">'Bowl_5w_sc'</span><span class="p">,</span>  
                     <span class="s">'Bowl_Balls_sc'</span><span class="p">,</span> <span class="s">'Bowl_Runs_sc'</span><span class="p">,</span><span class="s">'Bowl_Wkts_sc'</span><span class="p">]</span>

<span class="c"># divide by innings count since it is more relevant than match count</span>
<span class="n">data</span><span class="p">[</span><span class="n">bat_features_scaled</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bat_features_raw</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Inns'</span><span class="p">])</span>
<span class="n">data</span><span class="p">[</span><span class="n">bowl_features_scaled</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bowl_features_raw</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s">'Bowl_Inns'</span><span class="p">])</span>

<span class="c"># these are the meaningful features which will be the input for our model. </span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Bat_Ave'</span><span class="p">,</span><span class="s">'Bat_HS'</span><span class="p">,</span> <span class="s">'Bat_SR'</span><span class="p">]</span> <span class="o">+</span> <span class="n">bat_features_scaled</span> <span class="o">+</span> <span class="p">[</span><span class="s">'Bowl_Ave'</span><span class="p">,</span><span class="s">'Bowl_Econ'</span><span class="p">,</span><span class="s">'Bowl_SR'</span><span class="p">,</span><span class="s">'Bowl_BBIW'</span><span class="p">,</span> <span class="s">'Bowl_BBIR'</span><span class="p">,</span> <span class="s">'Bowl_BBMW'</span><span class="p">,</span> <span class="s">'Bowl_BBMR'</span><span class="p">]</span> <span class="o">+</span> <span class="n">bowl_features_scaled</span>

<span class="c"># fill numerical features with zero</span>
<span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre>
</div>
<blockquote>
  <p>It can be argued that averaging the runs scored duplicates the batting average feature. Leaving aside subtle differences in the way in which batting averages are calculated, we would still keep both features to see how our model learns the difference in both the features and assigns weight accordingly.</p>
</blockquote>

<p>Now let us plot the scaled runs scored value vs the innings played.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"Bat_Runs_sc"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"Bat_Inns"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-inns-vs-bat-runs-sc.png" alt="Bat Inns vs Bat Runs Scaled" /></p>

<p>Clearly this is a far better representation of batting capabilities of a player. You can see there is less dependency on the number of innings played. It is not hard to imagine how this scaling affects our final prediction. The impact is obvious when we plot batting runs and bowling wickets (likely to be the most important features) in a KDE plot. Here is the KDE plot before scaling:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"Bowl_Wkts"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"Bat_Runs"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">'kde'</span><span class="p">)</span>
</code></pre>
</div>
<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-inns-vs-bat-runs-kde-before.png" alt="Bowl Wickets vs Bat Runs KDE plot" /></p>

<p>There is no clear clustering indicating that our classification is not going to be effective. In comparison, if we generate the same chart for scaled values, there is a clear grouping.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"Bowl_Wkts_sc"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"Bat_Runs_sc"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">'kde'</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-inns-vs-bat-runs-kde-after.png" alt="Bowl Wickets Scaled vs Bat Runs Scaled KDE plot" /></p>

<p>This much more promising. Remember, your model will only perform as well as the data you feed in. If the input data is already confused, there is very little a mathematical model can do. Now that we have almost all that we need we will extract those records that have <code class="highlighter-rouge">playing role</code> information and use it for our training &amp; testing. To avoid outliers corrupting our model, we will also exclude players who played less than 5 matches.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># remove players who played less than 5 matches</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'Bio_Playing_role'</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Mat'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)]</span>
</code></pre>
</div>

<h3 id="data-transformation">Data Transformation</h3>

<p>Next let us look at our target feature which is <code class="highlighter-rouge">playing role</code>. We need to understand the values it can assume. Let us look at the unique values for the player features.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Check the unique playing roles to identify mapping function</span>
<span class="n">data</span><span class="p">[</span><span class="s">'Bio_Playing_role'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>array([nan, 'Top-order batsman', 'Bowler', 'Middle-order batsman',
       'Wicketkeeper batsman', 'Allrounder', 'Batsman', 'Opening batsman',
       'Wicketkeeper', 'Bowling allrounder', 'Batting allrounder'], dtype=object)
</code></pre>
</div>

<p>The playing role definiton is too granular. We want fewer variety of roles so that each role gets sufficient sample data points to train the model. Also the role tagging done by Cricinfo is not consistent. For e.g., not all opening batsmen have been tagged with the opening batsman role. So we define a mapping function to group playing roles in to 4 different categories <code class="highlighter-rouge">['Batsman','Bowler','Wicketkeeper','Allrounder']</code></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_role</span><span class="p">(</span><span class="n">role</span><span class="p">):</span>
    <span class="k">if</span>  <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">role</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">'keeper'</span> <span class="ow">in</span> <span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Wicketkeeper"</span>
        <span class="k">elif</span> <span class="s">'rounder'</span> <span class="ow">in</span> <span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Allrounder"</span>
        <span class="k">elif</span> <span class="s">'atsman'</span> <span class="ow">in</span> <span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Batsman"</span>
        <span class="k">elif</span> <span class="s">'owler'</span> <span class="ow">in</span> <span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Bowler"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">""</span>
    
<span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'Bio_Playing_role'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">get_role</span><span class="p">)</span>
</code></pre>
</div>
<p>Note that this feature is a categorical data. It is different from a numerical data such as height or weight. When we want to use Deep Neural Networks we need to represent the target features as numerical data. We will assign one column for each playing role and set its value to one when that playing role fits the player well. Then the function of our model will be to assign a value close to 1 for one of these columns and a value close to 0 for the rest.</p>

<p>It is called One-Hot encoding. Turns out this is a frequent task, so pandas has a handy inbuilt function to perform this.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code>
<span class="c"># y is categorical feature</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span>

<span class="c"># Convert categorical data into numerical columns</span>
<span class="n">y_cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c"># X is the input features. We need to covert it from pandas dataframe to numpy array to feed in to our models</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</code></pre>
</div>

<p>Let us see the new <code class="highlighter-rouge">y_cat</code> dataframe</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">y_cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Allrounder</th>
      <th>Batsman</th>
      <th>Bowler</th>
      <th>Wicketkeeper</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>19</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td>20</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <td>22</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>25</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td>28</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>One might be tempted to assign unique numbers for each category ( say 1: Batsman, 2: Bowler etc.,) but that will not work. There is no quantitative relation between categories. Assigning raw numbers implies that there is a numerical progression to the categories. Sometimes it can work for contiguous data such as day of the month, but even then one has to be aware of the bounds and circularity of the target variables.</p>
</blockquote>

<h3 id="scaling-data">Scaling data</h3>
<p>Some fields vary over a larger range compared to the rest. Remember we did a preliminary scaling by dividing these values with the number of innings. But that is not sufficient since it only made sure that one feature (‘no. of innings’) did not overtly influence another feature (‘runs scored’). But each features themselves lie between different extremities. For e.g, <code class="highlighter-rouge">Bowling Wickets Scaled</code> only ranges from 0 to 5 whereas <code class="highlighter-rouge">Batting Runs Scaled</code> ranges from 0 to 50. Most machine learning models works the best when the features are vary within the same range. If we let these datapoints influence our calculation without modification, wickets taken will have negligible influence.</p>

<p>So we perform another round of scaling for all input data points. We will use the <code class="highlighter-rouge">MinMax Scaler</code> from Scikit library. This will scale the values such that largest value becomes one and smallest value becomes zero.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="n">mms</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c"># X_mms will our new input array with all values scaled to be between 0 and 1</span>
<span class="n">X_mms</span> <span class="o">=</span> <span class="n">mms</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="training-the-model">Training the model</h2>

<h3 id="deep-neural-network">Deep Neural Network</h3>

<p>First we will try to run a Deep Neural Network model on this data. Here are the necessary modules to import.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">Adadelta</span><span class="p">,</span> <span class="n">RMSprop</span>
<span class="kn">from</span> <span class="nn">keras.wrappers.scikit_learn</span> <span class="kn">import</span> <span class="n">KerasClassifier</span>
<span class="kn">import</span> <span class="nn">keras.backend</span> <span class="kn">as</span> <span class="nn">K</span>
</code></pre>
</div>

<p>Create the Keras Sequential model. I am using a DNN with 1 hidden layer and 1 output layer. The hidden layer has 15 nodes. The number of nodes in the output layer should as the number of categories. So we will go with 4.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_baseline</span><span class="p">():</span>
    <span class="c"># create model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s">'he_normal'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s">'he_normal'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">))</span>
    <span class="c"># Compile model</span>
    <span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>    
    <span class="k">return</span> <span class="n">model</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">softmax</code> is a popular activation function for classification problems. In simple words, an activation function is a simple function that decides whether to output TRUE or FALSE for each category. This <code class="highlighter-rouge">softmax</code> function receives an array of values from the previous layer and returns a new array which adds up to 1. The category with the largest value is deemed likely match for our data.</p>

<blockquote>
  <p><code class="highlighter-rouge">Softmax</code> highlights only the likeliest category for a data. Here for simplicity sake, we assume that our categories are mutually exclusive, i.e, a player can only belong to one category at a time. There are other data types where a single entry can belong to more than one category at a time. We may need to use different activation function for that. Again, know your data before deciding on activation function.</p>
</blockquote>

<p>The loss function is <code class="highlighter-rouge">categorical_crossentropy</code>. A Loss Function can be thought of as a course correction function which measures the perceived error as our model navigates to ideal set of weights over multiple iterations. Categorical Cross-Entropy loss function penalizes weights that are sure to be wrong. It is a common loss function used for classification problems.</p>

<p>These are the important attributes that closely follows our problem definition. Most of the other parameters can be fiddled with.</p>

<p>Next we will use Keras to train the model. The result is a Keras Classifier function whose weights are trained on our data. We can use this function to predict values for inputs which we haven’t seen so far.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># evaluate model with standardized dataset</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">KerasClassifier</span><span class="p">(</span><span class="n">build_fn</span><span class="o">=</span><span class="n">create_baseline</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre>
</div>
<p>We cannot use all of the data to train our model. The model will closely follow our existing model. It won’t be useful to predict any values we haven’t seen so far. This is called overfitting.</p>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/overfitting.png" alt="Overfitting" /></p>
<p align="center">Example of overfitting - Source Wikipedia </p>

<p>To avoid this, we will split the data into train and test datasets. We will use the former to train the model and compute the scores based on the testing against test data for each iteration of cross-validation. Scikit’s provides a helper function called <code class="highlighter-rouge">cross_val_score</code> to assist in this. <code class="highlighter-rouge">StratifiedKFold</code> is the genertor strategy we will use for selecting this train/test datasets. It splits the data into K folds (set to 10 in our case), trains it on K-1 datasets and tests it against the left out dataset, while preserving the class distribution of the data.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># set the random state to a fixed number for reproducing the results</span>
<span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">X_mms</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Results: </span><span class="si">%.2</span><span class="s">f</span><span class="si">%% </span><span class="s">(</span><span class="si">%.2</span><span class="s">f</span><span class="si">%%</span><span class="s">)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre>
</div>

<p>I got a result of 82.2% accuracy. Not bad for the first attempt, particularly since we employed gross simplifications and trained the model with only with around 450 records. The results that you get may be slightly different since we shuffle the data before generating folds.</p>

<h3 id="random-forest-classifier">Random Forest Classifier</h3>

<p>This time let us try to model the data using <code class="highlighter-rouge">Random Forest classifier</code>. Random Forest Classifier is a much simpler method than neural networks. It relies on building multiple decision trees and assembling the results of these decision trees.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="c"># Instantiate model with 1000 decision trees</span>
<span class="n">rf_estimator</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>

<span class="n">rf_results</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">rf_estimator</span><span class="p">,</span> <span class="n">X_mms</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Results: </span><span class="si">%.2</span><span class="s">f</span><span class="si">%% </span><span class="s">(</span><span class="si">%.2</span><span class="s">f</span><span class="si">%%</span><span class="s">)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">rf_results</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">rf_results</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre>
</div>

<p>You will notice that Random Forest Classifier has performed significantly better than the DNN classifier. I got 87.28% accuracy, which is amazing since Random Forest is several times faster and less resource intensive than the DNN classifier. And I didn’t even have to run it on top of tensorflow and make use of GPU. Decision trees are quite effective at classification tasks but they tend to overfit.</p>

<h2 id="reviewing-the-results">Reviewing the results</h2>

<p>Since our Random Forest model has performed significantly better, we will use that model to predict the unseen roles of players.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Fit the estimator on available data</span>
<span class="n">rf_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mms</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c"># np array to hold all of the input data</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>

<span class="c"># An ugly hack to drop infinity values introduced as part of some of the pre-processing tasks</span>
<span class="n">P</span><span class="p">[</span><span class="n">P</span> <span class="o">&gt;</span> <span class="mf">1e308</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c"># Min Max Scaling</span>
<span class="n">P_mms</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

<span class="c"># Prediction based on the Random forest model</span>
<span class="n">data</span><span class="p">[</span><span class="s">'predicted_role_rf'</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">P_mms</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="confusion-matrix">Confusion Matrix</h3>
<p>A score alone is not a good indicator that our model has performed well. We need to review its performance by plotting <code class="highlighter-rouge">Confusion Matrix</code>. It is a simple matrix plot based on known test data with predicted values plotted against the true value. The diagonal entries represent correct prediction, rest represents confused values. Let us plot Confusin Matrix for our data.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">mat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span><span class="o">!=</span><span class="s">''</span><span class="p">)][</span><span class="s">'role'</span><span class="p">],</span> 
                       <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span><span class="o">!=</span><span class="s">''</span><span class="p">)][</span><span class="s">'predicted_role_rf'</span><span class="p">],</span>
                       <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Batsman'</span><span class="p">,</span><span class="s">'Bowler'</span><span class="p">,</span><span class="s">'Allrounder'</span><span class="p">,</span><span class="s">'Wicketkeeper'</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">'d'</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'true label'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'predicted label'</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/confusion-matrix.png" alt="Confusion Matrix" /></p>

<p>We can see that the model is quite effective in matching the pure roles such as Batsman or Bowler. When it comes to mixed roles such as Allrounder or Wicketkeeper, it fares not that well. Part of the problem lies in our assumption that the roles are mutually exclusive i.e, a player cannot be both Batsman and Bowler at the same time. So we identify only around 37% of the all rounders succesfully. Later we will see that there are other reasons why the predicted role doesn’t match the role marked in cricinfo.</p>

<h3 id="reviewing-the-results-1">Reviewing the results</h3>

<p>Let us see the cases where our predictions differed from the roles defined in cricinfo:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s">'predicted_role_rf'</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">''</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Mat'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)][[</span><span class="s">'Bio_Full_name'</span><span class="p">,</span><span class="s">'predicted_role_rf'</span><span class="p">,</span> <span class="s">'role'</span><span class="p">,</span> <span class="s">'Bio_Playing_role'</span><span class="p">]]</span>
</code></pre>
</div>

<p>I have extracted the differences for popular players of recent times. Subjectively speaking our model hasn’t performed too bad. There seems to be some merit to the classification offered by the model compared to the playing role assigned in cricinfo bio page.</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Bio_Full_name</th>
      <th>predicted_role_rf</th>
      <th>role</th>
      <th>Bio_Playing_role</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>38</td>
      <td>Stephen Norman John O’Keefe</td>
      <td>Bowler</td>
      <td>Allrounder</td>
      <td>Allrounder</td>
    </tr>
    <tr>
      <td>44</td>
      <td>Glenn James Maxwell</td>
      <td>Batsman</td>
      <td>Allrounder</td>
      <td>Batting allrounder</td>
    </tr>
    <tr>
      <td>88</td>
      <td>Andrew Symonds</td>
      <td>Batsman</td>
      <td>Allrounder</td>
      <td>Allrounder</td>
    </tr>
    <tr>
      <td>227</td>
      <td>Shai Diego Hope</td>
      <td>Batsman</td>
      <td>Wicketkeeper</td>
      <td>Wicketkeeper batsman</td>
    </tr>
    <tr>
      <td>281</td>
      <td>Brendon Barrie McCullum</td>
      <td>Batsman</td>
      <td>Wicketkeeper</td>
      <td>Wicketkeeper batsman</td>
    </tr>
    <tr>
      <td>970</td>
      <td>Angelo Davis Mathews</td>
      <td>Batsman</td>
      <td>Allrounder</td>
      <td>Allrounder</td>
    </tr>
    <tr>
      <td>1437</td>
      <td>Abraham Benjamin de Villiers</td>
      <td>Batsman</td>
      <td>Wicketkeeper</td>
      <td>Wicketkeeper batsman</td>
    </tr>
  </tbody>
</table>

<p>In most cases, Cricinfo’s playing role is also based on the ODI and T20 formats. Some of the players like ABD Villiers and Brendon McCullum have donned multiple roles but given up gloves for the games longest format. So we can’t really fault the model here for identifying them as batsman. Then there are other cases of a player being regarded as All rounder based on the role they play in shorter formats.</p>

<p>Next to the most interesting part- let us see how our model behaves for the data it hasn’t seen i.e., the classification of those players whose playing role is missing in their bio page. For ease of identification, I have filtered only those players who have played 100 matches or more.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s">'predicted_role_rf'</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'role'</span><span class="p">]</span> <span class="o">==</span> <span class="s">''</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Mat'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="p">)][[</span><span class="s">'Bio_Full_name'</span><span class="p">,</span><span class="s">'predicted_role_rf'</span><span class="p">,</span> <span class="s">'role'</span><span class="p">,</span> <span class="s">'Bio_Playing_role'</span><span class="p">]]</span>
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>Bio_Full_name</th>
      <th>predicted_role_rf</th>
      <th>role</th>
      <th>Bio_Playing_role</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>134</td>
      <td>Mark Edward Waugh</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>137</td>
      <td>Mark Anthony Taylor</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>139</td>
      <td>Ian Andrew Healy</td>
      <td>Wicketkeeper</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>599</td>
      <td>Sourav Chandidas Ganguly</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>743</td>
      <td>Anil Kumble</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>925</td>
      <td>Brian Charles Lara</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>929</td>
      <td>Carl Llewellyn Hooper</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>937</td>
      <td>Courtney Andrew Walsh</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>957</td>
      <td>Desmond Leo Haynes</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1072</td>
      <td>Kapildev Ramlal Nikhanj</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1074</td>
      <td>Dilip Balwant Vengsarkar</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1088</td>
      <td>Sunil Manohar Gavaskar</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1257</td>
      <td>Cuthbert Gordon Greenidge</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1258</td>
      <td>Isaac Vivian Alexander Richards</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1284</td>
      <td>Clive Hubert Lloyd</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1326</td>
      <td>Warnakulasuriya Patabendige Ushantha Joseph Chaminda Vaas</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1463</td>
      <td>Makhaya Ntini</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1474</td>
      <td>Gary Kirsten</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>1676</td>
      <td>Alec James Stewart</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2020</td>
      <td>Inzamam-ul-Haq</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2168</td>
      <td>Graham Alan Gooch</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2205</td>
      <td>Wasim Akram</td>
      <td>Bowler</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2216</td>
      <td>Saleem Malik</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2320</td>
      <td>Geoffrey Boycott</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2366</td>
      <td>Michael Colin Cowdrey</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2381</td>
      <td>Mohammad Javed Miandad Khan</td>
      <td>Batsman</td>
      <td> </td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>

<p>Even a cursory look can tell us that our model worked splendidly. It is surprising how many prominent player bio pages has their playing role information missing. Well, it looks like even a simple ML model can fix that gap.</p>

<p>Let us see how the two most critical features (<code class="highlighter-rouge">Bat_Runs_sc</code> and <code class="highlighter-rouge">Bowl_Wkts_sc</code>) affects our predicted role.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s">"bright"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="s">'Bowl_Wkts_sc'</span><span class="p">,</span><span class="s">'Bat_Runs_sc'</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Mat'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">],</span>
           <span class="n">hue</span><span class="o">=</span><span class="s">'predicted_role_rf'</span><span class="p">,</span> <span class="n">fit_reg</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">],[</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</code></pre>
</div>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-runs-bowl-wkts-roles.png" alt="Bat Runs vs Bowl Wkts" /></p>

<p>I have plotted a diagonal line, below which most of the points are clustered. It represents a kind of pareto-frontier which only exceptional players can breach. Note that there is no statistical basis for my choice of x and y intercepts, I just based it on visual inspection. Let us see the list of players who reside above this threshold.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'Bat_Mat'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'Bowl_Wkts_sc*100 + Bat_Runs_sc*7 &gt; 700 '</span><span class="p">)[[</span><span class="s">'Bio_Full_name'</span><span class="p">,</span><span class="s">'Bat_Mat'</span><span class="p">,</span><span class="s">'predicted_role_rf'</span><span class="p">,</span><span class="s">'Bowl_Wkts_sc'</span><span class="p">,</span><span class="s">'Bat_Runs_sc'</span><span class="p">]]</span>
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>Bio_Full_name</th>
      <th>Bat_Mat</th>
      <th>predicted_role_rf</th>
      <th>Bowl_Wkts_sc</th>
      <th>Bat_Runs_sc</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>62</td>
      <td>Steven Peter Devereux Smith</td>
      <td>59</td>
      <td>Batsman</td>
      <td>0.288136</td>
      <td>98.237288</td>
    </tr>
    <tr>
      <td>377</td>
      <td>Ravindrasinh Anirudhsinh Jadeja</td>
      <td>35</td>
      <td>Bowler</td>
      <td>4.714286</td>
      <td>33.600000</td>
    </tr>
    <tr>
      <td>380</td>
      <td>Ravichandran Ashwin</td>
      <td>55</td>
      <td>Bowler</td>
      <td>5.527273</td>
      <td>37.363636</td>
    </tr>
    <tr>
      <td>456</td>
      <td>Christopher Lance Cairns</td>
      <td>62</td>
      <td>Allrounder</td>
      <td>3.516129</td>
      <td>53.548387</td>
    </tr>
    <tr>
      <td>526</td>
      <td>Shakib Al Hasan</td>
      <td>51</td>
      <td>Allrounder</td>
      <td>3.686275</td>
      <td>70.470588</td>
    </tr>
    <tr>
      <td>720</td>
      <td>Sikandar Raza Butt</td>
      <td>9</td>
      <td>Allrounder</td>
      <td>1.444444</td>
      <td>84.111111</td>
    </tr>
    <tr>
      <td>832</td>
      <td>Donald George Bradman</td>
      <td>52</td>
      <td>Batsman</td>
      <td>0.038462</td>
      <td>134.538462</td>
    </tr>
    <tr>
      <td>1133</td>
      <td>Herbert Vivian Hordern</td>
      <td>7</td>
      <td>Bowler</td>
      <td>6.571429</td>
      <td>36.285714</td>
    </tr>
    <tr>
      <td>1177</td>
      <td>Richard John Hadlee</td>
      <td>86</td>
      <td>Bowler</td>
      <td>5.011628</td>
      <td>36.325581</td>
    </tr>
    <tr>
      <td>1240</td>
      <td>Yasir Shah</td>
      <td>28</td>
      <td>Bowler</td>
      <td>5.892857</td>
      <td>15.892857</td>
    </tr>
    <tr>
      <td>1468</td>
      <td>Jacques Henry Kallis</td>
      <td>166</td>
      <td>Allrounder</td>
      <td>1.759036</td>
      <td>80.054217</td>
    </tr>
    <tr>
      <td>1548</td>
      <td>Charles Thomas Biass Turner</td>
      <td>17</td>
      <td>Bowler</td>
      <td>5.941176</td>
      <td>19.000000</td>
    </tr>
    <tr>
      <td>1748</td>
      <td>Garfield St Aubrun Sobers</td>
      <td>93</td>
      <td>Allrounder</td>
      <td>2.526882</td>
      <td>86.365591</td>
    </tr>
    <tr>
      <td>1825</td>
      <td>Michael John Procter</td>
      <td>7</td>
      <td>Bowler</td>
      <td>5.857143</td>
      <td>32.285714</td>
    </tr>
    <tr>
      <td>1838</td>
      <td>Robert Graeme Pollock</td>
      <td>23</td>
      <td>Batsman</td>
      <td>0.173913</td>
      <td>98.086957</td>
    </tr>
    <tr>
      <td>1849</td>
      <td>Edgar John Barlow</td>
      <td>30</td>
      <td>Allrounder</td>
      <td>1.333333</td>
      <td>83.866667</td>
    </tr>
    <tr>
      <td>1860</td>
      <td>Trevor Leslie Goddard</td>
      <td>41</td>
      <td>Allrounder</td>
      <td>3.000000</td>
      <td>61.365854</td>
    </tr>
    <tr>
      <td>2157</td>
      <td>Ian Terence Botham</td>
      <td>102</td>
      <td>Allrounder</td>
      <td>3.754902</td>
      <td>50.980392</td>
    </tr>
    <tr>
      <td>2285</td>
      <td>Mulvantrai Himmatlal Mankad</td>
      <td>44</td>
      <td>Allrounder</td>
      <td>3.681818</td>
      <td>47.931818</td>
    </tr>
    <tr>
      <td>2386</td>
      <td>Imran Khan Niazi</td>
      <td>88</td>
      <td>Allrounder</td>
      <td>4.113636</td>
      <td>43.261364</td>
    </tr>
    <tr>
      <td>2522</td>
      <td>George Aubrey Faulkner</td>
      <td>25</td>
      <td>Allrounder</td>
      <td>3.280000</td>
      <td>70.160000</td>
    </tr>
    <tr>
      <td>2741</td>
      <td>George Joseph Thompson</td>
      <td>6</td>
      <td>Allrounder</td>
      <td>3.833333</td>
      <td>45.500000</td>
    </tr>
    <tr>
      <td>2769</td>
      <td>Sydney Francis Barnes</td>
      <td>27</td>
      <td>Bowler</td>
      <td>7.000000</td>
      <td>8.962963</td>
    </tr>
    <tr>
      <td>2809</td>
      <td>Thomas Richardson</td>
      <td>14</td>
      <td>Bowler</td>
      <td>6.285714</td>
      <td>12.642857</td>
    </tr>
    <tr>
      <td>2821</td>
      <td>John James Ferris</td>
      <td>9</td>
      <td>Bowler</td>
      <td>6.777778</td>
      <td>12.666667</td>
    </tr>
    <tr>
      <td>2845</td>
      <td>George Alfred Lohmann</td>
      <td>18</td>
      <td>Bowler</td>
      <td>6.222222</td>
      <td>11.833333</td>
    </tr>
  </tbody>
</table>

<p>The list is dominated by exceptional all-rounders. Among specialists, bowlers fare better. Perhaps it is my fault that I set the bar for greatness too high. The <code class="highlighter-rouge">Bat_Runs_sc</code> of Bradman is so far ahead of the rest, that it one tends to choose a higher value for y-intercept.</p>

<p>Finally let us plot <code class="highlighter-rouge">Bat_Runs_sc</code> against predicted playing role using a violin plot. This will shows distribution of runs scored across the multiple categories of playing role. We can see that for batsmen, the bulk of the violin plot is top heavy whereas for the bowlers it is bottom heavy.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'predicted_role_rf'</span><span class="p">,</span> 
               <span class="n">y</span><span class="o">=</span><span class="s">'Bat_Runs_sc'</span><span class="p">,</span>
               <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
               <span class="n">scale</span><span class="o">=</span><span class="s">'width'</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="/assets/images/2018/04/predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-2/bat-runs-roles-violin-plot.png" alt="Bat Runs Violin Plot" /></p>

<h2 id="conclusion">Conclusion</h2>
<p>If you review the length of the posts, less than 20% is allocated to running the actual machine learning code. That closely reflects the time spent on this project as well. Bulk of the time is spent in collecting and curating the data. Also the results from RandomForest Classifier is revealing. Right tool for the right job is often more effective than a generic tool which is universally useful.</p>

<p>Machine Learning and Data science is a vast subject. Despite the length of this post, I have barely touched the surface of this domain. Apart from the knowledge of tools and procedures, one needs to have a good understanding of the data and be conscious of the inherent biases in the numerical models. Errors may creep in during</p>

<p>Finally, <a href="http://scikit-learn.org/stable/">scikit-learn</a> is an excellent resource for learning and practising Machine learning. It has excellent documentation and helper functions for many of the common tasks. <a href="https://github.com/jakevdp/PythonDataScienceHandbook/">Python Data Science Handbook</a> is another great resource which is available for free.</p>
]]></content>
      <categories>
        
          <category> Machine Learning </category>
        
      </categories>
      <tags>
        
          <tag> pandas </tag>
        
          <tag> keras </tag>
        
          <tag> machine learning </tag>
        
          <tag> visualization </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Predicting the playing role of a cricketer using Machine Learning (Part 1)]]></title>
      <url>/machine%20learning/2018/04/23/2018-04-23-predicting-the-playing-role-of-a-cricketer-using-machine-learning-part-1/</url>
      <content type="html"><![CDATA[<p>In this project, we will apply Machine Learning techniques to predict whether a particular cricket player is a batsman or bowler based on his career stats. First we will use Deep Neural Networks (DNN) model and later compare the results with a simpler classifier algorithm such as Random Forest Classifier.</p>

<p>For the uninitiated, Cricket is a game of bat and ball, much similar to baseball. Cricket players have different roles to play in a game. Batsman’s role is to score runs while not losing their wicket, bowlers role is to get the batsman’s wicket while restricting their run score in due process. Allrounders can do both batting and bowling role well. A wicketkeeper is a specialist role whose purpose is to catch behind the wickets during the bowling innings. If you really intend to understand tne data behind this exercise, my half-baked explanations are barely sufficient. I suggest to refer to better reference such as <a href="https://www.britannica.com/sports/cricket-sport">this</a>.</p>

<p>For the sake of consistency, we will consider only test players. Apart from being a puritan choice, the playing role of a player may differ from format to format and so we can’t expect a consistent prediction. The cricinfo player bio page has this <code class="highlighter-rouge">playing role</code> information, but that covers only around 20% of the test players. For vast majority of players we only have numerical stats but no description whether the player is a batsman or a bowler.</p>

<p>This is a perfect problem for ML to assist. We have a decent amount of training data (600+ players) and good amount of features (statistics) to base our prediction on. It would also be interesting to observe which features are relevant to our consideration of a player as batsman or bowler.</p>

<p>This is by no means a comprehensive tutorial for ML. The goal of this post is to serve as gentle introduction and wet the appetite for newcomers. So in the process, I would cover the following areas:</p>

<ol>
  <li>Data collection</li>
  <li>Data processing</li>
  <li>Machine Learning</li>
  <li>Data visualization</li>
</ol>

<h2 id="data-collection">Data Collection</h2>
<p>Most ML examples work with pre-processed data but in reality data is seldom available prepackaged. For this problem, we will have to scrape the data off cricinfo website. We will use Scrapy for getting this info off cricinfo website.</p>

<p>The Scrapy tool is well-documented and has some nice tutorials to get started. However I will attempt my own brief introduction.</p>

<p>To start we create a project as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scrapy startproject &lt;project_name&gt;
</code></pre>
</div>

<p>This will create the necessary folder structure. It will also create some boilerplate code which we can customize to our will later on.</p>

<blockquote>
  <p>The default folder structure creates a parent folder and child folder with the same name. Do not get confused. All Scrapy commands are executed in the parent folder (where )</p>
</blockquote>

<p>Ultimately our objective is to perform a web scraping using <code class="highlighter-rouge">scrapy crawl</code> command which looks like the one below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd &lt;project_name&gt;
Scrapy crawl &lt;spider_name&gt; -o &lt;file_name&gt;.csv
</code></pre>
</div>

<p>In this command, the <code class="highlighter-rouge">spider_name</code> is the name attribute of a spider class. This spider class file should be located under the spiders directory (<project_name>/<project_name>/spiders/*.py). The `file_name` is the output file name, csv being our chosen export format. Let us see the steps involved in reaching to this stage.</project_name></project_name></p>

<h3 id="spider-class">Spider class</h3>
<p>Start with the skeleton code required for scraping. Here is the skeleton spider class file we will use:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">Scrapy</span>

<span class="k">class</span> <span class="nc">CricinfoSpider</span><span class="p">(</span><span class="n">Scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"players"</span>

    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># list of starting urls</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c"># do some fancy web scraping</span>
        <span class="k">pass</span>
</code></pre>
</div>

<blockquote>
  <p>The file name of this python class is arbitrary</p>
</blockquote>

<blockquote>
  <p>The spiders directory can contain multiple python file each implementing its own spider logic. The spider name attribute should be unique across all these files.</p>
</blockquote>

<p>A Spider class should contain the following:</p>
<ol>
  <li>name attribute to be called from the Scrapy command line</li>
  <li>start_urls is a list holding the URLS which act as the starting pages of our scraping.</li>
  <li>parse function which performs the grunt of scraping the data. The parse function can also recursively call itself to scrape more pages or it can also have a callback function which can be further customized.</li>
</ol>

<p>The starting page for our scraping should be the one containing links to all player profile pages. In cricinfo, there is no such global directory. However there is a page for players who represented a country. The URL is like this</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://www.espncricinfo.com/ci/content/player/caps.html?country=1;class=1
</code></pre>
</div>

<p>Notice the <a href="http://www.ronstauffer.com/blog/understanding-a-url/">parameters</a> in the URL which we can manipulate to enumerate all test playing nations. The class parameter represents the game type- for test matches it is 1. Since the list of test playing nations is only a handful, I manually determined that the country code for test playing nations are 1 to 10 and 25 (25 is for Bangladesh, the latest addition to test playing nations). Armed with this info, we can define our start_urls as follows:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">'http://www.espncricinfo.com/ci/content/player/caps.html?country={0};class=1'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="mi">25</span><span class="p">]]</span>
</code></pre>
</div>

<p>During a scraping process, Scrapy will issue a GET request to each one of these start_urls. If we get a valid HTTP 200 response, the response body will be passed on to parse function.</p>

<h3 id="parse-function">Parse function:</h3>
<p>The parse function receives the response object and extracts useful info from it. Our starting page doesn’t have the data that we need but contains the links to the player stats page which is what we want. So we will extract the links to player stats page and define another parse function to extract the statistics.</p>

<p>To extract the links, we will use CSS selectors. Looking at the source code of the page, we can see that all links to player stats has a class name of <code class="highlighter-rouge">ColumnistSmry</code>. But that is not enough to uniquely identify player links since match links also has the same class name. We can further filter by matching the target URL which is expected to contain the string “player”. So our CSS selector for extracting relevant URLs would be:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>response.css('a.ColumnistSmry[href*="player"]::attr(href)') 
</code></pre>
</div>

<p>Once we extract the link, Scrapy provides a handy <code class="highlighter-rouge">response.follow</code> function which navigates to the extracted link and can execute a callback function. This callback function will handle all our stats extraction since it will work directly with the player stats page. At this point, rest of the code is just a matter of studying the source code and extracting features using css selectors.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
    <span class="c">#follow player links</span>
    <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'a.ColumnistSmry[href*="player"]::attr(href)'</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_player</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_player</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">player</span> <span class="o">=</span> <span class="n">PlayerItem</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">".ciPlayerinformationtxt"</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'.engineTable'</span><span class="p">)</span>

    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'span::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'b::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>

    <span class="n">batting</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">batting_keys</span> <span class="o">=</span> <span class="n">batting</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'th::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
    <span class="n">batting_values</span> <span class="o">=</span> <span class="n">batting</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'tr.data1'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'td::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">batting_keys</span><span class="p">):]</span>

    <span class="n">bowling</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bowling_keys</span> <span class="o">=</span> <span class="n">bowling</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'th::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
    <span class="n">bowling_values</span> <span class="o">=</span> <span class="n">bowling</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'tr.data1'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'td::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">bowling_keys</span><span class="p">):]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">'Bio_'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">title_clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">player</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batting_keys</span><span class="p">,</span> <span class="n">batting_values</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">'Bat_'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">title_clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">player</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bowling_keys</span><span class="p">,</span> <span class="n">bowling_values</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">'Bowl_'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">title_clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">player</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">player</span>
</code></pre>
</div>

<blockquote>
  <p>If you find it difficult to define appropriate CSS selector for any element, you can always use inspector tool from Developer tools in Chrome or firefox. You can right click on the interesting code block and copy CSS selector or Xpath (Xpath is also supported in Scrapy)</p>
</blockquote>

<h3 id="items-class">Items Class:</h3>
<p>In the parse function, you can note that I am updating the parsed information in to a class called <code class="highlighter-rouge">PlayerItem()</code>. It is an instance of Scrapy.Item class and its attributes are defined in items.py file. Here is a brief snippet of my <code class="highlighter-rouge">items.py</code> file.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Scrapy</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">PlayerItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="c"># define the fields for your item here like:</span>
    <span class="n">Bio_Full_name</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">Bio_Born</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">Bio_Current_age</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">Bio_Major_teams</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">Bio_Playing_role</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre>
</div>

<p>You don’t have to always use a Item class. One can simply yield the values from parse function and it will output to CSV just fine. However without an Item class, the fields of the CSV file is determined by the fields in the first record processed. Any new field that may appear in subsequent scraped records will be silently dropped. For that reason, it is preferrable to define the structure of our parsed data ahead using an Item class.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Finally we can save the result of our hardwork to a precocious CSV file and guard it (Just kidding… If you lose or corrupt the file, just delete it and scrape again! ).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scrapy crawl players -o players.csv
</code></pre>
</div>

<p>In the next post we will look at pre-processing this data for our machine learning work. To learn more about Scrapy, do head to its official site. The documentation is excellent and once you grasp hold of the structure, rest falls in to place quite easily.</p>
]]></content>
      <categories>
        
          <category> Machine Learning </category>
        
      </categories>
      <tags>
        
          <tag> python </tag>
        
          <tag> Scrapy </tag>
        
          <tag> web-scraping </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Introduction to OpenStack Networking for Network Engineers]]></title>
      <url>/networking/2018/03/22/2018-03-22-introduction-to-openstack-networking-for-network-engineers/</url>
      <content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>This post is a gentle introduction to networking with Openstack using the Neutron module. Being an introduction, we will not focus on setting up OpenStack from scratch. Instead we will familiarize ourselves with core concepts of Neutron and common administrative tasks. We will use the latest release of Openstack, <strong>Queens</strong>.</p>

<p>For ease of setup, we will make use of pre-packaged Devstack environment. Devstack is a set of scripts from official OpenStack community that allows us to quickly build an Openstack instance with latest versions of all modules. It is very useful for testing and training purposes.</p>

<h2 id="neutron-concepts">Neutron Concepts</h2>
<p>Let us go through the important terms first:</p>

<ol>
  <li>
    <p><strong>Network</strong> - A Network is a logical container of entities. To think of it in physical networking terms, it can represent a site, a DC, a campus- or anything else termed as a single network. In AWS terms, a network is similar to a VPC. Note that the definition of a Network is not entirely arbitrary as we may encounter some design choices when deciding CIDR, load balancers, routers, external gateway etc.,</p>
  </li>
  <li>
    <p><strong>Subnet</strong> - Subnet is similar to a vlan in traditional networking. All hosts in the same Subnet can talk to each other and share the same address space. For beginners, it is possible to confuse a Subnet with Network since both terms are used interchangeably in traditional networking. But keep in mind that one network can contain many subnets. The concept of a Subnet is similar both in OpenStack and AWS.</p>
  </li>
  <li>
    <p><strong>Port</strong> - A port is a virtual NIC card which is used by resources to access network. A port is tied to a subnet and assigned with a Security group (introduced below). In AWS terms, it is similar to ENI (Elastic Network Interface)</p>
  </li>
  <li>
    <p><strong>Security Group</strong> - Security groups are like port ACL in traditional networking, except that the filtering happens at the hypervisor level. Multiple ports can share the same security group. By default, entities assigned to the same Security Group can talk to each other. It is also similar in scope and function to the Security Group in AWS.</p>
  </li>
  <li>
    <p><strong>Floating IP</strong> - This is similar to elastic IP in AWS. These are not tied to any port and can be re-assigned to other ports dynamically. The closest feature in traditional networking would be a static NAT. In AWS terms, it is called Elastic IP.</p>
  </li>
</ol>

<h2 id="objective">Objective</h2>

<p>We will create the below topology on Openstack. Hosts <code class="highlighter-rouge">host-1</code> &amp; <code class="highlighter-rouge">host-2</code> will be on same subnet while <code class="highlighter-rouge">host-3</code> will be on another subnet. We will enable reachability between all 3 hosts. Finally, we will also enable bi-directional connectivity to <code class="highlighter-rouge">host-1</code> from internet.</p>

<p><img src="/assets/images/2018/04/introduction-to-openstack-networking-for-network-engineers/topology.png" alt="topology" /></p>

<h2 id="preparing-the-environment">Preparing the environment</h2>

<p>Make home directory for our devstack installation and download the latest copy of DevStack there. I am using Ubuntu 16.04 for my environment.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo mkdir -p /opt/stack &amp;&amp; cd /opt/stack
$ sudo git clone https://git.openstack.org/openstack-dev/devstack

</code></pre>
</div>

<p>Switch to devstack folder and create a user account using the pre-built script. The script grants passwordless root privilege to this account. Switch to the stack account to proceed with rest of the steps.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd devstack
$ sudo bash tools/create-stack-user.sh
</code></pre>
</div>

<p>Switch to <code class="highlighter-rouge">stack</code> user and create a config file. Provide your preferred password which will be used for rest of the setup. The local.conf should be present in the root directory of devstack (same location as stack.sh)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo su stack
$ vi local.conf
[[local|localrc]]
ADMIN_PASSWORD=password
DATABASE_PASSWORD=$ADMIN_PASSWORD
RABBIT_PASSWORD=$ADMIN_PASSWORD
SERVICE_PASSWORD=$ADMIN_PASSWORD
</code></pre>
</div>

<p>Run the setup script <code class="highlighter-rouge">stack.sh</code> and watch the magic happen. It takes a while since the script installs almost every component of Openstack.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>./stack.sh
</code></pre>
</div>

<blockquote>
  <p>DevStack also provides convenient script to tear down the environment and start from scratch. So once we are done with our testing, we can run <code class="highlighter-rouge">unstack.sh</code> to bring the environment back to a blank state.</p>
</blockquote>

<p>After the installation is complete, source the openrc file to import openstack commands in your searchpath.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>source openrc
</code></pre>
</div>

<h2 id="building-subnets">Building subnets</h2>

<p>Before we create new subnets, let us list the set of pre-built subnets that were setup as part of devstack deployment.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack network list -f yaml
  - ID: 1fe4e71c-d94e-400c-bcee-8067b621c827
    Name: public
    Subnets: c0718110-7493-46bf-ba48-720762e47934, fab15575-ae4f-4528-bf0d-ac40d2000484
  - ID: 2ebe2084-6dae-40dd-8704-7954944238d7
    Name: private
    Subnets: 244ed014-8b9f-4e4d-ab12-9931ecec4238, 265de598-d881-4d58-a185-1a69be39b2fd
</code></pre>
</div>

<blockquote>
  <p>The default output format is table. To simplify horizontal scrolling, I have selected yaml output using the -f switch.</p>
</blockquote>

<p>Create a new network called <code class="highlighter-rouge">inside</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack network create inside
  +---------------------------+--------------------------------------+
  | Field                     | Value                                |
  +---------------------------+--------------------------------------+
  | admin_state_up            | UP                                   |
  | availability_zone_hints   |                                      |
  | availability_zones        |                                      |
  | created_at                | 2018-04-01T09:14:41Z                 |
  | description               |                                      |
  | dns_domain                | None                                 |
  | id                        | a0fc23dd-f1a5-4e9b-9d58-ea63b30d076b |
  | ipv4_address_scope        | None                                 |
  | ipv6_address_scope        | None                                 |
  | is_default                | False                                |
  | is_vlan_transparent       | None                                 |
  | mtu                       | 1450                                 |
  | name                      | inside                               |
  | port_security_enabled     | True                                 |
  | project_id                | 9d390c83cc4e46c7a40167dee68075f0     |
  | provider:network_type     | None                                 |
  | provider:physical_network | None                                 |
  | provider:segmentation_id  | None                                 |
  | qos_policy_id             | None                                 |
  | revision_number           | 2                                    |
  | router:external           | Internal                             |
  | segments                  | None                                 |
  | shared                    | False                                |
  | status                    | ACTIVE                               |
  | subnets                   |                                      |
  | tags                      |                                      |
  | updated_at                | 2018-04-01T09:14:41Z                 |
  +---------------------------+--------------------------------------+
</code></pre>
</div>

<p>Next we will create new subnets. Before that, let us list down the existing subnets for reference.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>stack@openstack-instance-2:~/devstack$ openstack subnet list -f yaml
- ID: 244ed014-8b9f-4e4d-ab12-9931ecec4238
  Name: private-subnet
  Network: 2ebe2084-6dae-40dd-8704-7954944238d7
  Subnet: 10.0.0.0/26
- ID: 265de598-d881-4d58-a185-1a69be39b2fd
  Name: ipv6-private-subnet
  Network: 2ebe2084-6dae-40dd-8704-7954944238d7
  Subnet: fd7b:34b0:9a57::/64
</code></pre>
</div>

<p>Create a new subnet within the network. We will call it <code class="highlighter-rouge">net-01</code> and assign a subnet range of <code class="highlighter-rouge">10.1.1.0/24</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack subnet create net-01 --network inside --subnet-range 10.1.1.0/24
  +-------------------+--------------------------------------+
  | Field             | Value                                |
  +-------------------+--------------------------------------+
  | allocation_pools  | 10.1.1.2-10.1.1.254                  |
  | cidr              | 10.1.1.0/24                          |
  | created_at        | 2018-04-01T09:20:13Z                 |
  | description       |                                      |
  | dns_nameservers   |                                      |
  | enable_dhcp       | True                                 |
  | gateway_ip        | 10.1.1.1                             |
  | host_routes       |                                      |
  | id                | 0317aa4a-84d3-44df-8781-3f04d558a473 |
  | ip_version        | 4                                    |
  | ipv6_address_mode | None                                 |
  | ipv6_ra_mode      | None                                 |
  | name              | net-01                               |
  | network_id        | a0fc23dd-f1a5-4e9b-9d58-ea63b30d076b |
  | project_id        | 9d390c83cc4e46c7a40167dee68075f0     |
  | revision_number   | 0                                    |
  | segment_id        | None                                 |
  | service_types     |                                      |
  | subnetpool_id     | None                                 |
  | tags              |                                      |
  | updated_at        | 2018-04-01T09:20:13Z                 |
  +-------------------+--------------------------------------+
</code></pre>
</div>

<p>As mentioned earlier, the relation between subnet and network is many-to-one. So we can create another subnet <code class="highlighter-rouge">net-02</code> within the same <code class="highlighter-rouge">inside</code> network.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack subnet create net-02 --network inside --subnet-range 10.1.2.0/24
  +-------------------+--------------------------------------+
  | Field             | Value                                |
  +-------------------+--------------------------------------+
  | allocation_pools  | 10.1.2.2-10.1.2.254                  |
  | cidr              | 10.1.2.0/24                          |
  | created_at        | 2018-04-01T09:21:07Z                 |
  | description       |                                      |
  | dns_nameservers   |                                      |
  | enable_dhcp       | True                                 |
  | gateway_ip        | 10.1.2.1                             |
  | host_routes       |                                      |
  | id                | 6e5f2220-29da-4679-962f-22934f2c3d49 |
  | ip_version        | 4                                    |
  | ipv6_address_mode | None                                 |
  | ipv6_ra_mode      | None                                 |
  | name              | net-02                               |
  | network_id        | a0fc23dd-f1a5-4e9b-9d58-ea63b30d076b |
  | project_id        | 9d390c83cc4e46c7a40167dee68075f0     |
  | revision_number   | 0                                    |
  | segment_id        | None                                 |
  | service_types     |                                      |
  | subnetpool_id     | None                                 |
  | tags              |                                      |
  | updated_at        | 2018-04-01T09:21:07Z                 |
  +-------------------+--------------------------------------+
</code></pre>
</div>

<h2 id="creating-nova-compute-instances">Creating nova compute instances</h2>

<p>We need to know the image names available before creating an instance. List the images available.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack image list -f yaml
  - ID: 2a5fbb6b-b694-4f76-ac19-4af358d1c7e8
    Name: cirros-0.3.5-x86_64-disk
    Status: active
</code></pre>
</div>

<p>Cirros is a tiny image available as part of devstack, useful for testing purpose. Let us create two instances under inside network running cirros image.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack server create /
  --flavor m1.tiny --image cirros-0.3.5-x86_64-disk --network inside host --min 2 --max 2
  +-----------------------------+-----------------------------------------------------------------+
  | Field                       | Value                                                           |
  +-----------------------------+-----------------------------------------------------------------+
  | OS-DCF:diskConfig           | MANUAL                                                          |
  | OS-EXT-AZ:availability_zone |                                                                 |
  | OS-EXT-STS:power_state      | NOSTATE                                                         |
  | OS-EXT-STS:task_state       | scheduling                                                      |
  | OS-EXT-STS:vm_state         | building                                                        |
  | OS-SRV-USG:launched_at      | None                                                            |
  | OS-SRV-USG:terminated_at    | None                                                            |
  | accessIPv4                  |                                                                 |
  | accessIPv6                  |                                                                 |
  | addresses                   |                                                                 |
  | adminPass                   | odJy58yPdHnz                                                    |
  | config_drive                |                                                                 |
  | created                     | 2018-04-01T09:25:55Z                                            |
  | flavor                      | m1.tiny (1)                                                     |
  | hostId                      |                                                                 |
  | id                          | dbda4926-4ca6-40be-b673-d0c811ae43c2                            |
  | image                       | cirros-0.3.5-x86_64-disk (2a5fbb6b-b694-4f76-ac19-4af358d1c7e8) |
  | key_name                    | None                                                            |
  | name                        | host-1                                                          |
  | progress                    | 0                                                               |
  | project_id                  | 9d390c83cc4e46c7a40167dee68075f0                                |
  | properties                  |                                                                 |
  | security_groups             | name='default'                                                  |
  | status                      | BUILD                                                           |
  | updated                     | 2018-04-01T09:25:55Z                                            |
  | user_id                     | dfd4e794f59f48549016de1263c30dbb                                |
  | volumes_attached            |                                                                 |
  +-----------------------------+-----------------------------------------------------------------+
</code></pre>
</div>

<blockquote>
  <p>Either min or max parameter is necessary. or else server build fails miserably with no clue as to what went wrong.</p>
</blockquote>

<p>Note that in the above command we specified only the network and not subnet. But this network has two subnets. So let us see which subnet is chosen to run the nova compute instances.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack server list -f yaml
  - Flavor: m1.tiny
    ID: 5ea3d968-aa29-4911-b658-e0b6498b09f4
    Image: cirros-0.3.5-x86_64-disk
    Name: host-2
    Networks: inside=10.1.1.9
    Status: ACTIVE
  - Flavor: m1.tiny
    ID: dbda4926-4ca6-40be-b673-d0c811ae43c2
    Image: cirros-0.3.5-x86_64-disk
    Name: host-1
    Networks: inside=10.1.1.10
    Status: ACTIVE
</code></pre>
</div>

<p>It turns out the first subnet <code class="highlighter-rouge">net-01</code> we created is being used. But if we want to specify <code class="highlighter-rouge">net-02</code> for instance creation, it is more tricky. We need to create a port in that subnet and attach its nic during instance creation.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack port create \
  --network a0fc23dd-f1a5-4e9b-9d58-ea63b30d076b --fixed-ip subnet=6e5f2220-29da-4679-962f-22934f2c3d49 if-host-02
  +-----------------------+-------------------------------------------------------------------------+
  | Field                 | Value                                                                   |
  +-----------------------+-------------------------------------------------------------------------+
  | admin_state_up        | UP                                                                      |
  | allowed_address_pairs |                                                                         |
  | binding_host_id       | None                                                                    |
  | binding_profile       | None                                                                    |
  | binding_vif_details   | None                                                                    |
  | binding_vif_type      | None                                                                    |
  | binding_vnic_type     | normal                                                                  |
  | created_at            | 2018-04-01T09:32:31Z                                                    |
  | data_plane_status     | None                                                                    |
  | description           |                                                                         |
  | device_id             |                                                                         |
  | device_owner          |                                                                         |
  | dns_assignment        | None                                                                    |
  | dns_domain            | None                                                                    |
  | dns_name              | None                                                                    |
  | extra_dhcp_opts       |                                                                         |
  | fixed_ips             | ip_address='10.1.2.5', subnet_id='6e5f2220-29da-4679-962f-22934f2c3d49' |
  | id                    | 2b9635bf-8f93-4663-9c6d-f40f0492195c                                    |
  | ip_address            | None                                                                    |
  | mac_address           | fa:16:3e:40:08:73                                                       |
  | name                  | if-host-02                                                              |
  | network_id            | a0fc23dd-f1a5-4e9b-9d58-ea63b30d076b                                    |
  | option_name           | None                                                                    |
  | option_value          | None                                                                    |
  | port_security_enabled | True                                                                    |
  | project_id            | 9d390c83cc4e46c7a40167dee68075f0                                        |
  | qos_policy_id         | None                                                                    |
  | revision_number       | 6                                                                       |
  | security_group_ids    | bd41b78c-974c-4854-b808-dec11575964b                                    |
  | status                | DOWN                                                                    |
  | subnet_id             | None                                                                    |
  | tags                  |                                                                         |
  | trunk_details         | None                                                                    |
  | updated_at            | 2018-04-01T09:32:31Z                                                    |
  +-----------------------+-------------------------------------------------------------------------+
</code></pre>
</div>

<p>Now create an instance in this subnet. Use the port id from above output to specify the nic.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack server create --flavor m1.tiny \
  --image cirros-0.3.5-x86_64-disk --nic port-id=2b9635bf-8f93-4663-9c6d-f40f0492195c  host-3 --max 1
  +-----------------------------+-----------------------------------------------------------------+
  | Field                       | Value                                                           |
  +-----------------------------+-----------------------------------------------------------------+
  | OS-DCF:diskConfig           | MANUAL                                                          |
  | OS-EXT-AZ:availability_zone |                                                                 |
  | OS-EXT-STS:power_state      | NOSTATE                                                         |
  | OS-EXT-STS:task_state       | scheduling                                                      |
  | OS-EXT-STS:vm_state         | building                                                        |
  | OS-SRV-USG:launched_at      | None                                                            |
  | OS-SRV-USG:terminated_at    | None                                                            |
  | accessIPv4                  |                                                                 |
  | accessIPv6                  |                                                                 |
  | addresses                   |                                                                 |
  | adminPass                   | hnN294KgUTrY                                                    |
  | config_drive                |                                                                 |
  | created                     | 2018-04-01T09:52:23Z                                            |
  | flavor                      | m1.tiny (1)                                                     |
  | hostId                      |                                                                 |
  | id                          | 376c3d59-f74c-4b3b-a4c7-5b9fb9d3eef7                            |
  | image                       | cirros-0.3.5-x86_64-disk (2a5fbb6b-b694-4f76-ac19-4af358d1c7e8) |
  | key_name                    | None                                                            |
  | name                        | host-3                                                          |
  | progress                    | 0                                                               |
  | project_id                  | 9d390c83cc4e46c7a40167dee68075f0                                |
  | properties                  |                                                                 |
  | security_groups             | name='default'                                                  |
  | status                      | BUILD                                                           |
  | updated                     | 2018-04-01T09:52:23Z                                            |
  | user_id                     | dfd4e794f59f48549016de1263c30dbb                                |
  | volumes_attached            |                                                                 |
  +-----------------------------+-----------------------------------------------------------------+
</code></pre>
</div>

<p>Before we move on to next section, tet us check the server instances we have created so far.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack server list -f yaml
  - Flavor: m1.tiny
    ID: 376c3d59-f74c-4b3b-a4c7-5b9fb9d3eef7
    Image: cirros-0.3.5-x86_64-disk
    Name: host-3
    Networks: inside=10.1.2.5
    Status: ACTIVE
  - Flavor: m1.tiny
    ID: 5ea3d968-aa29-4911-b658-e0b6498b09f4
    Image: cirros-0.3.5-x86_64-disk
    Name: host-2
    Networks: inside=10.1.1.9
    Status: ACTIVE
  - Flavor: m1.tiny
    ID: dbda4926-4ca6-40be-b673-d0c811ae43c2
    Image: cirros-0.3.5-x86_64-disk
    Name: host-1
    Networks: inside=10.1.1.10
    Status: ACTIVE
</code></pre>
</div>

<h2 id="neutron-networking-between-hosts">Neutron networking between hosts</h2>

<p>Let us see the subnet membership of each ports.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack port list -f yaml --fixed-ip subnet=net-01
  - Fixed IP Addresses: 'ip_address=''10.1.1.2'', subnet_id=''0317aa4a-84d3-44df-8781-3f04d558a473''

      ip_address=''10.1.2.2'', subnet_id=''6e5f2220-29da-4679-962f-22934f2c3d49'''
    ID: 6764de9f-deec-494b-a9b4-0903bfbfefea
    MAC Address: fa:16:3e:8f:47:41
    Name: ''
    Status: ACTIVE
  - Fixed IP Addresses: ip_address='10.1.1.9', subnet_id='0317aa4a-84d3-44df-8781-3f04d558a473'
    ID: ab283b4a-5738-48c9-8a53-343a1e5c795d
    MAC Address: fa:16:3e:9d:b6:7f
    Name: ''
    Status: ACTIVE
  - Fixed IP Addresses: ip_address='10.1.1.10', subnet_id='0317aa4a-84d3-44df-8781-3f04d558a473'
    ID: de7ee5de-e694-4ff3-9763-d7fb86e0038c
    MAC Address: fa:16:3e:7a:ce:84
    Name: ''
    Status: ACTIVE

  stack@openstack-instance-2:~/devstack$ openstack port list -f yaml --fixed-ip subnet=net-02
  - Fixed IP Addresses: ip_address='10.1.2.5', subnet_id='6e5f2220-29da-4679-962f-22934f2c3d49'
    ID: 2b9635bf-8f93-4663-9c6d-f40f0492195c
    MAC Address: fa:16:3e:40:08:73
    Name: if-host-02
    Status: ACTIVE
  - Fixed IP Addresses: 'ip_address=''10.1.1.2'', subnet_id=''0317aa4a-84d3-44df-8781-3f04d558a473''

      ip_address=''10.1.2.2'', subnet_id=''6e5f2220-29da-4679-962f-22934f2c3d49'''
    ID: 6764de9f-deec-494b-a9b4-0903bfbfefea
    MAC Address: fa:16:3e:8f:47:41
    Name: ''
    Status: ACTIVE
</code></pre>
</div>

<p>We can see that one port appears in both the subnets (MAC address: <code class="highlighter-rouge">fa:16:3e:8f:47:41</code>). This is the default DNS server of the network and gets attached to the subnet automatically unless we explicitly specify otherwise.</p>

<p>To test connectivity we need to console in to the hosts. We will use <code class="highlighter-rouge">virsh</code> to console in to the instances. First let us list the hosts.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ sudo virsh list
   Id    Name                           State
  ----------------------------------------------------
   1     instance-00000001              running
   2     instance-00000002              running
   3     instance-00000003              running
</code></pre>
</div>

<p>Console to the first instance <code class="highlighter-rouge">host-1</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ sudo virsh console 1
  Connected to domain instance-00000001
  Escape character is ^]

  login as 'cirros' user. default password: 'cubswin:)'. use 'sudo' for root.
  cirros login: cirros
  Password: 
  $ ip add | grep 'inet.*10'
      inet 10.1.1.10/24 brd 10.1.1.255 scope global eth0
  $ sudo hostname cirros-1-1-1-10
  $ export PS1="\h$ "
</code></pre>
</div>

<p>We will see that this host can talk to other host <code class="highlighter-rouge">host-2</code> within the same subnet.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cirros-1-1-1-10$ ping 10.1.1.9
PING 10.1.1.9 (10.1.1.9): 56 data bytes
64 bytes from 10.1.1.9: seq=0 ttl=64 time=4.409 ms
64 bytes from 10.1.1.9: seq=1 ttl=64 time=1.070 ms
64 bytes from 10.1.1.9: seq=2 ttl=64 time=1.437 ms

--- 10.1.1.9 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 1.070/2.305/4.409 ms
</code></pre>
</div>

<p>But it cannot reach host-3 which is a different subnet (<code class="highlighter-rouge">net-02</code>)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cirros-1-1-1-10$ ping 10.1.2.5
PING 10.1.2.5 (10.1.2.5): 56 data bytes

--- 10.1.2.5 ping statistics ---
3 packets transmitted, 0 packets received, 100% packet loss
</code></pre>
</div>

<p>Likewise, the host cannot reach external network such as internet.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cirros-1-1-1-10$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 0 packets received, 100% packet loss
</code></pre>
</div>

<p>Like in any tradional network, we need a router to allow traffic between different subnets. OpenStack Neutron provides a software defined router which can attach to multiple subnets and provide the same functionality.</p>

<p>Let us go ahead and create a router.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>stack@openstack-instance-2:~/devstack$ openstack router create demo_router
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | UP                                   |
| availability_zone_hints |                                      |
| availability_zones      |                                      |
| created_at              | 2018-04-02T00:14:29Z                 |
| description             |                                      |
| distributed             | False                                |
| external_gateway_info   | None                                 |
| flavor_id               | None                                 |
| ha                      | False                                |
| id                      | f36a24b0-e4a3-41de-9fdd-73f85df9dbaa |
| name                    | demo_router                          |
| project_id              | 9d390c83cc4e46c7a40167dee68075f0     |
| revision_number         | 1                                    |
| routes                  |                                      |
| status                  | ACTIVE                               |
| tags                    |                                      |
| updated_at              | 2018-04-02T00:14:29Z                 |
+-------------------------+--------------------------------------+
</code></pre>
</div>

<p>List the routers visible to validate the result. You can see an existing pre-built router and the one we created just now.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack router list -f yaml
  - Distributed: false
    HA: false
    ID: 58cc905f-4c8b-4641-ba92-a1a491d818ab
    Name: router1
    Project: 9d390c83cc4e46c7a40167dee68075f0
    State: UP
    Status: ACTIVE
  - Distributed: false
    HA: false
    ID: f36a24b0-e4a3-41de-9fdd-73f85df9dbaa
    Name: demo_router
    Project: 9d390c83cc4e46c7a40167dee68075f0
    State: UP
    Status: ACTIVE
</code></pre>
</div>

<p>Now we will attach our subnets to the router.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack router add subnet demo_router net-01
  stack@openstack-instance-2:~/devstack$ openstack router add subnet demo_router net-02
</code></pre>
</div>

<p>You can see one new port from each subnet getting attached to the router.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack port list -f yaml --router demo_router
  - Fixed IP Addresses: ip_address='10.1.1.1', subnet_id='0317aa4a-84d3-44df-8781-3f04d558a473'
    ID: 468ff846-fb1d-4ef2-85b0-3957885c59a8
    MAC Address: fa:16:3e:b1:31:fa
    Name: ''
    Status: ACTIVE
  - Fixed IP Addresses: ip_address='10.1.2.1', subnet_id='6e5f2220-29da-4679-962f-22934f2c3d49'
    ID: ee15064b-26f2-46ae-bc09-02db440edd3b
    MAC Address: fa:16:3e:7c:62:28
    Name: ''
    Status: ACTIVE
</code></pre>
</div>
<blockquote>
  <p>To reduce the output I have filtered the port list with an argument –router <router name="">. Most list commands have ability to filter output like this. Use the interactive help menu to figure out the filter options.</router></p>
</blockquote>

<p>Let us try to reach the host on the other network.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  cirros-1-1-1-10$ ping 10.1.2.5
  PING 10.1.2.5 (10.1.2.5): 56 data bytes
  64 bytes from 10.1.2.5: seq=0 ttl=63 time=4.141 ms
  64 bytes from 10.1.2.5: seq=1 ttl=63 time=1.499 ms

  --- 10.1.2.5 ping statistics ---
  2 packets transmitted, 2 packets received, 0% packet loss
  round-trip min/avg/max = 1.499/2.820/4.141 ms
</code></pre>
</div>

<p>Success! As expected, the host is one hop away.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  cirros-1-1-1-10$ traceroute 10.1.2.5
  traceroute to 10.1.2.5 (10.1.2.5), 30 hops max, 46 byte packets
   1  host-10-1-1-1.openstacklocal (10.1.1.1)  2.217 ms  0.360 ms  0.301 ms
   2  host-10-1-2-5.openstacklocal (10.1.2.5)  1.568 ms  1.155 ms  0.803 ms
</code></pre>
</div>

<p>But the outside world connection is not ready yet. For that we need to attach it to a public network. Recall that there was a pre-built public network as part of devstack setup. We will use this network to communicate to outside world.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack router set --external-gateway public demo_router
  stack@openstack-instance-2:~/devstack$ openstack router show demo_router -f yaml
  admin_state_up: UP
  availability_zone_hints: ''
  availability_zones: nova
  created_at: '2018-04-02T00:14:29Z'
  description: ''
  distributed: false
  external_gateway_info: '{"network_id": "1fe4e71c-d94e-400c-bcee-8067b621c827", "enable_snat":
    true, "external_fixed_ips": [{"subnet_id": "c0718110-7493-46bf-ba48-720762e47934",
    "ip_address": "172.24.4.3"}, {"subnet_id": "fab15575-ae4f-4528-bf0d-ac40d2000484",
    "ip_address": "2001:db8::6"}]}'
  flavor_id: null
  ha: false
  id: f36a24b0-e4a3-41de-9fdd-73f85df9dbaa
  interfaces_info: '[{"subnet_id": "0317aa4a-84d3-44df-8781-3f04d558a473", "ip_address":
    "10.1.1.1", "port_id": "468ff846-fb1d-4ef2-85b0-3957885c59a8"}, {"subnet_id": "6e5f2220-29da-4679-962f-22934f2c3d49",
    "ip_address": "10.1.2.1", "port_id": "ee15064b-26f2-46ae-bc09-02db440edd3b"}]'
  name: demo_router
  project_id: 9d390c83cc4e46c7a40167dee68075f0
  revision_number: 5
  routes: ''
  status: ACTIVE
  tags: ''
  updated_at: '2018-04-02T00:32:54Z'
</code></pre>
</div>
<blockquote>
  <p>The show command is similar to list command, but can show more detailed information about a single resource. As expected, it requires an additional unique identifier argument to identify the resource which we want to display.</p>
</blockquote>

<p>See that there is a new external_gateway_info section. Now let us try to reach the internet.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ sudo virsh console 1
  Connected to domain instance-00000001
  Escape character is ^]

  cirros-1-1-1-10$ ping 8.8.8.8
  PING 8.8.8.8 (8.8.8.8): 56 data bytes
  64 bytes from 8.8.8.8: seq=0 ttl=50 time=7.129 ms
  64 bytes from 8.8.8.8: seq=1 ttl=51 time=1.483 ms
  64 bytes from 8.8.8.8: seq=2 ttl=51 time=1.137 ms
  
  --- 8.8.8.8 ping statistics ---
  3 packets transmitted, 3 packets received, 0% packet loss
  round-trip min/avg/max = 1.137/3.249/7.129 ms
</code></pre>
</div>

<p>Success! To see how this traffic reaches out to internet, we will do tcpdump on the hypervisor.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/ sudo tcpdump 'host 8.8.8.8' -X
  tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
  listening on br-ex, link-type EN10MB (Ethernet), capture size 262144 bytes
  00:37:14.019550 IP 172.24.4.3 &gt; google-public-dns-a.google.com: ICMP echo request, id 49153, seq 0, length 64
    0x0000:  4500 0054 0979 4000 3f01 7205 ac18 0403  E..T.y@.?.r.....
    0x0010:  0808 0808 0800 5076 c001 0000 73cd 73ba  ......Pv....s.s.
    0x0020:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0030:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0040:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0050:  0000 0000                                ....
  00:37:14.020493 IP google-public-dns-a.google.com &gt; 172.24.4.3: ICMP echo reply, id 49153, seq 0, length 64
    0x0000:  4500 0054 0000 0000 3401 c67e 0808 0808  E..T....4..~....
    0x0010:  ac18 0403 0000 5876 c001 0000 73cd 73ba  ......Xv....s.s.
    0x0020:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0030:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0040:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x0050:  0000 0000    
</code></pre>
</div>

<p>The traffic from the host is being source NAT by the router to go out to the internet (recall from the earlier output that 172.24.4.3 belongs to the external gateway of the router). In traditional networking term this is called NAT overloading. This can provide only outbound connectivity for the host.</p>

<p>In order to provide inbound connectivity to the host, we need to create a floating ip. This is similar to elastic IP in AWS or staic NAT in traditional networking.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack floating ip create public
  +---------------------+--------------------------------------+
  | Field               | Value                                |
  +---------------------+--------------------------------------+
  | created_at          | 2018-04-02T00:44:14Z                 |
  | description         |                                      |
  | fixed_ip_address    | None                                 |
  | floating_ip_address | 172.24.4.5                           |
  | floating_network_id | 1fe4e71c-d94e-400c-bcee-8067b621c827 |
  | id                  | e2ff37e4-f8f5-4413-98aa-e0df516c1a3b |
  | name                | 172.24.4.5                           |
  | port_id             | None                                 |
  | project_id          | 9d390c83cc4e46c7a40167dee68075f0     |
  | qos_policy_id       | None                                 |
  | revision_number     | 0                                    |
  | router_id           | None                                 |
  | status              | DOWN                                 |
  | subnet_id           | None                                 |
  | tags                | []                                   |
  | updated_at          | 2018-04-02T00:44:14Z                 |
  +---------------------+--------------------------------------+
</code></pre>
</div>

<p>Attach this to our <code class="highlighter-rouge">host-1</code> instance. You can now see the floating IP also listed in the <code class="highlighter-rouge">openstack server list</code> output.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack server add floating ip host-1 172.24.4.5
  stack@openstack-instance-2:~/devstack$ openstack server list --name host-1 -f yaml
  - Flavor: m1.tiny
    ID: dbda4926-4ca6-40be-b673-d0c811ae43c2
    Image: cirros-0.3.5-x86_64-disk
    Name: host-1
    Networks: inside=10.1.1.10, 172.24.4.5
    Status: ACTIVE
</code></pre>
</div>

<p>Here you can see the floating ip is mapped to our port-id.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack floating ip show 172.24.4.5
  +---------------------+--------------------------------------+
  | Field               | Value                                |
  +---------------------+--------------------------------------+
  | created_at          | 2018-04-02T00:44:14Z                 |
  | description         |                                      |
  | fixed_ip_address    | 10.1.1.10                            |
  | floating_ip_address | 172.24.4.5                           |
  | floating_network_id | 1fe4e71c-d94e-400c-bcee-8067b621c827 |
  | id                  | e2ff37e4-f8f5-4413-98aa-e0df516c1a3b |
  | name                | 172.24.4.5                           |
  | port_id             | de7ee5de-e694-4ff3-9763-d7fb86e0038c |
  | project_id          | 9d390c83cc4e46c7a40167dee68075f0     |
  | qos_policy_id       | None                                 |
  | revision_number     | 2                                    |
  | router_id           | f36a24b0-e4a3-41de-9fdd-73f85df9dbaa |
  | status              | ACTIVE                               |
  | subnet_id           | None                                 |
  | tags                | []                                   |
  | updated_at          | 2018-04-02T00:47:14Z                 |
  +---------------------+--------------------------------------+
</code></pre>
</div>

<p>We require one last step to initiate inbound connections to the host. Recall that each ports are assigned with a security group. Since this is an inbound connection, we need to explicitly permit access in security group.</p>

<p>Check the Security Group assigned to our port.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack port 
    \show de7ee5de-e694-4ff3-9763-d7fb86e0038c -c 'security_group_ids' -f yaml
  security_group_ids: bd41b78c-974c-4854-b808-dec11575964b
</code></pre>
</div>

<p>Let us see the rules which are permitted by this security group.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack security group show bd41b78c-974c-4854-b808-dec11575964b  -f yaml
  created_at: '2018-04-01T09:01:20Z'
  description: Default security group
  id: bd41b78c-974c-4854-b808-dec11575964b
  name: default
  project_id: 9d390c83cc4e46c7a40167dee68075f0
  revision_number: 6
  rules: 'created_at=''2018-04-01T09:01:20Z'', direction=''ingress'', ethertype=''IPv4'',
    id=''2ab4f8a5-43ed-4f3e-8c43-cc854bc8feb3'', remote_group_id=''bd41b78c-974c-4854-b808-dec11575964b'',
    updated_at=''2018-04-01T09:01:20Z''

    created_at=''2018-04-01T09:01:20Z'', direction=''egress'', ethertype=''IPv6'', id=''5c33d0ac-8ee9-4bd7-951c-dca998931828'',
    updated_at=''2018-04-01T09:01:20Z''

    created_at=''2018-04-01T09:01:20Z'', direction=''ingress'', ethertype=''IPv6'',
    id=''d7c7a642-485b-482e-8d26-a958aaafa19e'', remote_group_id=''bd41b78c-974c-4854-b808-dec11575964b'',
    updated_at=''2018-04-01T09:01:20Z''

    created_at=''2018-04-01T09:01:20Z'', direction=''egress'', ethertype=''IPv4'', id=''f41405df-d0c9-4427-ba11-f0a26b025c3e'',
    updated_at=''2018-04-01T09:01:20Z'''
  tags: []
  updated_at: '2018-04-02T01:56:25Z'
</code></pre>
</div>

<p>Here you can see 4 rules, two each for IPv4 and IPv6. For egress rules, you can see that there is no remote prefix or group id configured. It means all outbound connections are permitted. For ingress traffic, you can see that the remote_group_id references to self. It means that all ports assigned to the same security group can send inbound traffic unhindered.</p>

<p>Let us add more rules to permit ICMP and SSH</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack security group rule create \
  --protocol icmp --ingress --remote-ip 0.0.0.0/0 default
  +-------------------+--------------------------------------+
  | Field             | Value                                |
  +-------------------+--------------------------------------+
  | created_at        | 2018-04-02T01:54:12Z                 |
  | description       |                                      |
  | direction         | ingress                              |
  | ether_type        | IPv4                                 |
  | id                | df23fec9-b87a-47ef-8f38-67472de46071 |
  | name              | None                                 |
  | port_range_max    | None                                 |
  | port_range_min    | None                                 |
  | project_id        | 9d390c83cc4e46c7a40167dee68075f0     |
  | protocol          | icmp                                 |
  | remote_group_id   | None                                 |
  | remote_ip_prefix  | 0.0.0.0/0                            |
  | revision_number   | 0                                    |
  | security_group_id | bd41b78c-974c-4854-b808-dec11575964b |
  | updated_at        | 2018-04-02T01:54:12Z                 |
  +-------------------+--------------------------------------+

  stack@openstack-instance-2:~/devstack$ openstack security group rule create \
  --protocol tcp --dst-port 22 --ingress --remote-ip 0.0.0.0/0 default
  +-------------------+--------------------------------------+
  | Field             | Value                                |
  +-------------------+--------------------------------------+
  | created_at        | 2018-04-02T01:56:25Z                 |
  | description       |                                      |
  | direction         | ingress                              |
  | ether_type        | IPv4                                 |
  | id                | adee3f3f-a5a0-497f-a12d-644e64c7015e |
  | name              | None                                 |
  | port_range_max    | 22                                   |
  | port_range_min    | 22                                   |
  | project_id        | 9d390c83cc4e46c7a40167dee68075f0     |
  | protocol          | tcp                                  |
  | remote_group_id   | None                                 |
  | remote_ip_prefix  | 0.0.0.0/0                            |
  | revision_number   | 0                                    |
  | security_group_id | bd41b78c-974c-4854-b808-dec11575964b |
  | updated_at        | 2018-04-02T01:56:25Z                 |
  +-------------------+--------------------------------------+
</code></pre>
</div>
<blockquote>
  <p>Note that I am using the security group name <code class="highlighter-rouge">default</code> as argument instead of security group id. As with most other arguments, we can use either name or the id. We can find the name from the output of previous show command.</p>
</blockquote>

<p>Now you can see 2 new rules added to the group</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ openstack security group rule list -c 'IP Protocol' -c 'IP Range' -c 'Port Range' -f yaml
  - IP Protocol: null
    IP Range: null
    Port Range: ''
  - IP Protocol: null
    IP Range: null
    Port Range: ''
  - IP Protocol: tcp
    IP Range: 0.0.0.0/0
    Port Range: '22:22'
  - IP Protocol: null
    IP Range: null
    Port Range: ''
  - IP Protocol: icmp
    IP Range: 0.0.0.0/0
    Port Range: ''
  - IP Protocol: null
    IP Range: null
    Port Range: ''
</code></pre>
</div>
<blockquote>
  <p>Note that in the previous list command output, there were lot of fields. Here I have used -c argument to select the interesting fields. To select multiple columns, we have to repeat this -c argument.</p>
</blockquote>

<p>Now we can initiate SSH and ICMP connections to this VM host using floating ip address.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  stack@openstack-instance-2:~/devstack$ ping 172.24.4.5
  PING 172.24.4.5 (172.24.4.5) 56(84) bytes of data.
  64 bytes from 172.24.4.5: icmp_seq=1 ttl=63 time=0.628 ms
  64 bytes from 172.24.4.5: icmp_seq=2 ttl=63 time=0.529 ms
  ^C
  --- 172.24.4.5 ping statistics ---
  2 packets transmitted, 2 received, 0% packet loss, time 1003ms
  rtt min/avg/max/mdev = 0.529/0.578/0.628/0.055 ms
  stack@openstack-instance-2:~/devstack$ ssh cirros@172.24.4.5
  cirros@172.24.4.5's password:
  cirros-1-1-1-10$ 
</code></pre>
</div>
<blockquote>
  <p>Recall that the hosts were able to ping each other even before we updated the security group. It is because all the ports were assigned to the default security group and hosts on security group can talk to each other by virtue of an implicit rule.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>
<p>I have barely scratched the surface of things possible with Openstack. However, this post should give a good idea about the general command structure and operation procedures in Openstack. For further learning, dig around the <a href="https://docs.openstack.org/neutron/queens/admin/">official documentation</a> (pay attention to openstack version in the docs, there can be major differences between each versions) or setup a lab environment and play around.</p>

<p>On the Neutron front, there are a lot of topics to explore such as ML2 network types, virtual switch types, L3 agents etc., Redhat’s <a href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/9/html-single/networking_guide/">official documentation</a> provides a good introduction to many of these components.</p>
]]></content>
      <categories>
        
          <category> Networking </category>
        
      </categories>
      <tags>
        
          <tag> openstack </tag>
        
          <tag> software defined networking </tag>
        
          <tag> networking </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Solving an ancient Chinese math puzzle with Constraint Programming using Google's OR-Tools]]></title>
      <url>/modelling/2017/12/09/2017-12-09-solving-an-ancient-chinese-math-puzzle-with-constraint-programming-using-googles-or-tools/</url>
      <content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p><a href="https://www.wikiwand.com/en/Constraint_programming">Constraint programming (CP)</a> is a subset of Operations Research (OR) where our task is to identify all feasible solutions to a given problem that satisfies a set of constraints. This is different from an optimization problem, where an objective function is defined and we arrive at solutions that either maximizes or minimizes an objective function.</p>

<p>CP is mostly well suited for solving logic puzzles, since most logic puzzles are based on constraints and enumerating feasible solutions. But apart from recreational maths, CP also has a lot of practical applications in Scheduling, Resource allocation, Manufacturing etc.,</p>

<p>Recently I came across <a href="https://developers.google.com/optimization/">or-tools</a> from Google github repo. It is a suite of libraries for solving Operations Research problems. I wanted to give it a try by solving a simple logic puzzle. The puzzle I chose is called <a href="https://www.wikiwand.com/en/Hundred_Fowls_Problem">Hundred Fowls Problem</a>. Let us see how it goes.</p>

<h2 id="hundred-fowls-problem">Hundred Fowls problem</h2>
<p>This puzzle found in the sixth-century work of mathematician Chang Chiu-chen called the “hundred fowls” problem asks:</p>

<blockquote>
  <p>If a rooster is worth five coins, a hen three coins, and three chickens together are worth one coin, how many roosters, hens, and chicks totalling 100 can be bought for 100 coins?</p>
</blockquote>

<p>This translates to solving a set of 2 algebraic equations with 3 variables. In real numbers, there are infinite solutions to this puzzle since we are short by one non-equivalent equation to bind values to 3 variables. However, buying non-integer number of fowls can get tricky, so we can safely assume that we are dealing with 3 integer valued variables here. This reduces the solution space to a finite count, but still there are more than one feasible solution. This is a perfect candidate for constraint programming since we need to identify all feasible solutions and not maximize/minimize an objective function.</p>

<h3 id="components-of-an-or-model">Components of an OR model</h3>
<p>A model for an optimization problem can be thought to have 3 components:</p>
<ul>
  <li>Decision variables</li>
  <li>Constraints</li>
  <li>Objectives</li>
</ul>

<p>Decision variables are the answer an OR problem tries to solve. In our case, it is the valid number of fowls of each type that we can buy. Constraints are the limits imposed on the problem. Here we have total cost and total bird count imposed as limits. An objective is the goal of an OR problem such as maximize profit or minimize project time etc., Most often in Constraint Programming, we don’t need to work with objectives and we don’t have one for our problem as well.</p>

<h3 id="setting-up-the-code">Setting up the code</h3>
<p>Let us first import the necessary modules and create a Solver and define our parameters.</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">ortools.constraint_solver</span> <span class="kn">import</span> <span class="n">pywrapcp</span>

<span class="n">solver</span> <span class="o">=</span> <span class="n">pywrapcp</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span><span class="s">"hundred_fowls"</span><span class="p">)</span>

<span class="n">ROOSTER_COST</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">HEN_COST</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="n">THREE_CHICK_COST</span>   <span class="o">=</span> <span class="mi">1</span>

<span class="n">total_cost</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">total_fowls</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre>
</div>

<h4 id="decision-variables">Decision Variables</h4>
<p>Let us first try to define the limits our decision variables can take i.e., the maximum number of roosters, hens or chicks that we need to consider. One can enumerate each fowl type up to the total count (100) but this increases the search domain unnecessarily. For e.g, we cannot buy more than 20 roosters since we would exceed 100 coins nor can we buy 300 chicks for 100 coins. So, we try to establish the upper limit for each of our decision variables as below:</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>

<span class="n">max_rooster</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_fowls</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">total_cost</span><span class="o">/</span><span class="n">ROOSTER_COST</span><span class="p">))</span>
<span class="n">max_hen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_fowls</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">total_cost</span><span class="o">/</span><span class="n">HEN_COST</span><span class="p">))</span>
<span class="n">max_chick_set</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">total_fowls</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">total_cost</span><span class="o">/</span><span class="n">THREE_CHICK_COST</span><span class="p">))</span> <span class="c"># a set of 3 chickens </span>
</code></pre>
</div>
<p>Notice that for chick count, we are grouping them in sets of three. This is because the unit cost of a chick is a fraction (1/3) and the solver doesn’t allow us to multiply float numbers with IntVar object (which we will come to know later). This is perfectly acceptable for our scenario since chick count always needs to be a multiple of 3 or else the total cost will never be an integer (100 in this case). Besides, this also reduces the search space for chick count by a factor of 3, eliminating obvious non-solutions.</p>

<p>We now have to spec out our decision variables. OR-Tools supports different types of decision variables such as Integers, Intervals etc., In our current challenge the decision variable is an integer so we assign it by using IntVar method. The first two values gives the lower and upper bounds for the variables. The last value is an arbitrary string handle for output representation. I am not sure under which scenarios the last variable will come to use, but likely it is an object name required for the underlying C++ code. The python module we use for or-tools is actually a wrapper for the core C++ code.</p>

<p>For our problem the decision variables can be defined as below:</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># since the puzzle requires us to buy atleast one fowl </span>
<span class="c"># of each type we will start enumerating from one</span>
<span class="n">rooster_count</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">IntVar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_rooster</span><span class="p">,</span> <span class="s">"Rooster"</span><span class="p">)</span>
<span class="n">hen_count</span>     <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">IntVar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_hen</span><span class="p">,</span> <span class="s">"Hen"</span><span class="p">)</span>
<span class="n">chick_set_count</span>    <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">IntVar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_chick_set</span><span class="p">,</span> <span class="s">"Chick"</span><span class="p">)</span>
</code></pre>
</div>
<h4 id="constraints">Constraints</h4>
<p>Next we add the constraints for our model. It is done using the “Add” method of Solver object.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">solver</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rooster_count</span> <span class="o">+</span> 
           <span class="n">hen_count</span> <span class="o">+</span> 
           <span class="n">chick_set_count</span><span class="o">*</span><span class="mi">3</span> <span class="o">==</span> <span class="n">total_fowls</span><span class="p">)</span>

<span class="n">solver</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rooster_count</span><span class="o">*</span><span class="n">ROOSTER_COST</span> <span class="o">+</span> 
           <span class="n">hen_count</span><span class="o">*</span><span class="n">HEN_COST</span> <span class="o">+</span> 
           <span class="n">chick_set_count</span><span class="o">*</span><span class="n">THREE_CHICK_COST</span> <span class="o">==</span> <span class="n">total_cost</span><span class="p">)</span>
</code></pre>
</div>
<h4 id="navigating-the-search-space">Navigating the search space</h4>
<p>Next we create a decision builder which specifies how to iterate through all possible values for our problems. It is done using the Phase method. The first arguemnt is an array of our decision variables. Second argument is how we choose the next value to try for our decision variable. Last argument is how we start assigning value to our variable (from minimum or maximum). We will go with the defauls although for larger problems, we could use some sort of heuristics to search only interesting portions of a search space. You can refer to <a href="http://www.lia.disi.unibo.it/Staff/MicheleLombardi/or-tools-doc/reference_manual/or-tools/src/constraint_solver/classoperations__research_1_1Solver.html#8bda7ed6e7e533cca4c44eba6efffc8b">or-tools documentation</a> for other search strategies.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">db</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">Phase</span><span class="p">([</span><span class="n">rooster_count</span><span class="p">,</span> <span class="n">hen_count</span><span class="p">,</span> <span class="n">chick_set_count</span><span class="p">],</span> 
                  <span class="n">solver</span><span class="o">.</span><span class="n">CHOOSE_FIRST_UNBOUND</span><span class="p">,</span> 
                  <span class="n">solver</span><span class="o">.</span><span class="n">ASSIGN_MIN_VALUE</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="solving-the-model">Solving the model</h3>
<p>Finally we solve our model and iterate through our solutions.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">solver</span><span class="o">.</span><span class="n">Solve</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">solver</span><span class="o">.</span><span class="n">NextSolution</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"{0} Roosters, {1} Hen and {2} Chicks"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rooster_count</span><span class="p">,</span> <span class="n">hen_count</span><span class="p">,</span> <span class="n">chick_set_count</span><span class="o">.</span><span class="n">Value</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Number of unique solutions found - {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
</code></pre>
</div>
<p>This produces 3 solutions to the puzzle.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Rooster(4) Roosters, Hen(18) Hen and 78 Chicks
Rooster(8) Roosters, Hen(11) Hen and 81 Chicks
Rooster(12) Roosters, Hen(4) Hen and 84 Chicks
Number of unique solutions found - 3
</code></pre>
</div>

<h2 id="further-reading">Further Reading</h2>

<p>or-tools manual on <a href="https://acrogenesis.com/or-tools/documentation/user_manual/manual/introduction/what_is_cp.html">Constraint Programming</a> is quite comprehensive. As always, best way to learn is to study existing code and implementations. In this regards, the <a href="https://github.com/google/or-tools/tree/master/examples">example scripts</a> from or-tools public repo is quite indispensable for learning. There is a good amount of example scripts for some of the most popular OR challenges.</p>
]]></content>
      <categories>
        
          <category> Modelling </category>
        
      </categories>
      <tags>
        
          <tag> or-tools </tag>
        
          <tag> python </tag>
        
          <tag> puzzle </tag>
        
          <tag> operations research </tag>
        
          <tag> constraint programming </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Jumbo Ping Fallacy- Using Monte-Carlo Simulation to model ping loss behavior]]></title>
      <url>/modelling/2017/11/24/jumbo-ping-fallacy-using-monte-carlo-simulation-to-model-ping-loss-behavior/</url>
      <content type="html"><![CDATA[<h2 id="background">Background</h2>
<p>Recently we had a cabling issue in our core infrastructure which caused around 3 to 12% packet loss across few IP streams. One of my colleagues made an interesting observation that when he tried to ping with large packet size (5000 bytes) the packet loss rose up to 40%. In his opinion, that meant some applications were experiencing up to 40% packet loss. I seldom do large packet ping tests unless I am troubleshooting MTU issues, so to me this observation was interesting.</p>

<p>At the outset, it may look like an aggravated problem. But you know that your network path MTU doesn’t support jumbo frames end-to-end. If so why is there a difference in packet loss rate when you ping with large datagams? Once you reason that the ping test results only represent ICMP datagram loss and not ethernet frame loss, you will realize that both tests results represent the same network performane but in different metrics. Interpreting them as two separate test cases is fallacious. Let us explore why.</p>

<h2 id="normal-ping-vs-large-ping">Normal ping vs Large ping</h2>
<p>In windows a normal ping packet size is 32 bytes and in most environments, the default MTU is 1500 bytes. So a single frame is sufficient to transmit a ping packet. Things get weirder when we ping with large packets. In windows, you can specify the ping packet size using -l option. Note that this size doesn’t include the packet header (20 bytes for IP header + 8 bytes for ICMP header). Which means with a 1500 MTU size, we can send only up to 1472 bytes in a single frame. Any length above this must be fragmented.</p>

<p>We can test this easily. Below is the result when pinging with 1472 as the ping size (<code class="highlighter-rouge">ping 8.8.8.8 -n 2 -l 1472</code>)</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Capturing on 'Ethernet 2'
    1   0.000000     10.1.1.1 → 8.8.8.8      ICMP 1514 Echo (ping) request  id=0x0001, seq=8/2048, ttl=128
    2   0.015698      8.8.8.8 → 10.1.1.1     ICMP 106 Echo (ping) reply    id=0x0001, seq=8/2048, ttl=45
2 packets captured
</code></pre>
</div>

<p>When we ping with just one more byte, you can see that 2 packets are sent in place of 1 ((<code class="highlighter-rouge">ping 8.8.8.8 -n 2 -l 1473</code>)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Capturing on 'Ethernet 2'
    1   0.000000     10.1.1.1 → 8.8.8.8      IPv4 1514 Fragmented IP protocol (proto=ICMP 1, off=0, ID=4fab)
    2   0.000016     10.1.1.1 → 8.8.8.8      ICMP 35 Echo (ping) request  id=0x0001, seq=10/2560, ttl=128
2 packets captured
</code></pre>
</div>

<p>So when we ping with 5000 bytes, 4 packets are sent. And ICMP protocol considers a datagram to be lost even when one of them fails. So the probability of the ICMP datagram loss is higher than the probability of single frame loss.</p>

<p>But is this what is happening in the ping test result? We can calculate the probability of datagram loss using probability theory but let us defer to it later on and do a numerical simulation first using Monte Carlo simulation.</p>

<h2 id="monte-carlo-simulation">Monte Carlo Simulation</h2>
<p><a href="https://www.wikiwand.com/en/Monte_Carlo_method">Monte carlo simulation</a> is a rather fancy title for a simple simulation using random event generator, but it is quite handy and widely used. Usually Monte Carlo simulation is useful for simulating events that are truly random in nature. In a chaotic backbone network, that handles traffic stream of different kinds, we can assume the frame loss to happen approximately in a random fashion.</p>

<p>Let us write a short program to simulate random packet loss.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">sampleCount</span> <span class="o">=</span> <span class="mi">100000</span>                               <span class="c"># total events in our simulation</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.03</span>                                           <span class="c"># ethernet frame loss probability</span>
<span class="n">grpSize</span> <span class="o">=</span> <span class="mi">4</span>                                        <span class="c"># packet count per datagram, 5000 bytes = 4 packets</span>
<span class="n">grpEventCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sampleCount</span><span class="o">/</span><span class="n">grpSize</span><span class="p">)</span>           <span class="c"># datagram count</span>

<span class="c"># generate random packets with p% packet loss</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">size</span><span class="o">=</span><span class="n">sampleCount</span><span class="p">,</span>
                          <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">])</span>

<span class="c"># group discrete packets into a datagram</span>
<span class="n">grpEvents</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grpEventCount</span><span class="p">,</span><span class="n">grpSize</span><span class="p">)</span> 

<span class="c"># function to determine datagram loss</span>
<span class="k">def</span> <span class="nf">checkFailure</span><span class="p">(</span><span class="n">grpEvent</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">grpEvent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">grpSize</span><span class="p">)</span>    <span class="c"># Return 1 if the success count is less than 3</span>

<span class="c"># count the result</span>
<span class="n">failCount</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">grpEvent</span> <span class="ow">in</span> <span class="n">grpEvents</span><span class="p">:</span>
    <span class="n">failCount</span> <span class="o">+=</span> <span class="n">checkFailure</span><span class="p">(</span><span class="n">grpEvent</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The probability of a group failure is {:.2f}</span><span class="si">%</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failCount</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">grpEvents</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>The probability of a group failure is 11.78%
</code></pre>
</div>

<p>There you see! Even a 3% ethernet frame loss translates to 12% packet loss for jumbo ping test. This is same as what we observed. Now this is just a simulation with random input. But does the math agree?</p>

<h2 id="using-probability-theory">Using Probability Theory</h2>
<p>If <code class="highlighter-rouge">p</code> is the probability of a single frame loss, <code class="highlighter-rouge">(1-p)</code> is the probability of a successful transfer. And a datagram is successful only if all of its frames are successful. So an ICMP datagram which is 4 frame long, will have <code class="highlighter-rouge">(1-p)**4</code> probability of succesful delivery. To calculate the failure rate, just take its inverse.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="mi">1</span><span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>
</code></pre>
</div>
<div class="highlighter-rouge"><pre class="highlight"><code>0.11470719000000007
</code></pre>
</div>

<p>As expected the simulation is slightly off from the calculated probability. But it will get closer to the real figure when we increase the simulation count.</p>

<h2 id="conclusion">Conclusion</h2>
<p>The exactness of our calculation hinges on the assumption of random nature of packet loss. While it happened to be close to true in my case, it need not be all the time. The link may be loaded in a bursty manner and since our ping streams are evenly spaced over time, their chances of failure may not be truly random.</p>

<p>Nevertheless, we should be wary of the difference between a datagram loss and ethernet loss while interpreting results. Consider the MTU of the network path while testing with different packet sizes.</p>

<h6 id="jupyter-notebook-version-of-this-post-can-be-viewed-here">Jupyter notebook version of this post can be viewed <a href="https://goo.gl/DYxpCo">here</a></h6>
]]></content>
      <categories>
        
          <category> Modelling </category>
        
      </categories>
      <tags>
        
          <tag> network </tag>
        
          <tag> python </tag>
        
          <tag> numpy </tag>
        
          <tag> probability </tag>
        
          <tag> scripting </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer]]></title>
      <url>/scripting/2017/10/29/emulating-angryip-scanner-with-nmap-scripting-engine-a-lua-scripting-primer/</url>
      <content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.</p>

<p><code class="highlighter-rouge">sudo nmap -sn &lt;subnet or ip range&gt;</code></p>

<p>On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc.</p>

<p>It is handy, but not complete. I would like to have some extra information such as hostnames (collected by various means not just DNS reverse lookup), platform info etc., Such details are available in tools such as AngryIP scanner, but I don’t prefer to launch a GUI tool for single task and keep it running until the task is done.</p>

<p>So let us try to implement a similar function using nmap script. There are existing scripts in nmap which performs advanced discovery and reconnaissance, but we want something lightweight, more generic and customizable to support more protocols. Nmap scripts run on top of Nmap Scripting Engine which runs on Lua. Learning it would expand the scope of these tools from just being a capable tool to a powerful tool with limitless possibilities.</p>

<p>Although this was my first attempt at Lua scripting, the endeavour turned out to be fairly simple. True it was not without its share of frustrations, most of which were related to wrapping my head around the way NSE (Nmap Scripting Engine) tosses the data around and lua data structures. But once you get the hang of it, it is really simple. So without much ado, let us get started.</p>

<h2 id="nse-script-structure">NSE Script structure</h2>
<p>A basic NSE script will have the following 3 sections:</p>
<ul>
  <li>The Head section is for meta information about the script. We need not worry about it for primer purpose but it is a good habit to put documentation info here while packaging the script for production. This section also feeds in to the NSE Documentation module (<a href="https://nmap.org/book/nsedoc.html">NSEDoc</a>) which provides a consistent way to represent the meta information about our script.</li>
  <li>The RULE section determines the scope of the script. It basically acts as a filter of nmap port-scan results that gets filtered to the Action section. The rule section should contain one of the following functions:
    <ul>
      <li>prerule()</li>
      <li>hostrule(host)</li>
      <li>portrule(host, port)</li>
      <li>postrule()</li>
    </ul>
  </li>
  <li>The Action section is mostly the brain of the script (although rule section can also contain some of the script logic). This section contains an Action section which reads data from the nmap scanning engine and carries out the script logic. The value returned by this function is also printed on the screen and captured by other nmap output methods. Note that this script is executed iteratively over either list of hosts or a list of (host, port) tuples. The ACTION section is indicated by the presence of a function named <code class="highlighter-rouge">action</code>.</li>
</ul>

<h2 id="diving-in">Diving In</h2>
<p>So let us go ahead and create a basic script. Our script will scan the target network and fetch the hostname from NETBIOS. Create a script file with .nse (I used host-discover.nse) extension as follows:</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="kd">local</span> <span class="n">netbios</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"netbios"</span>
<span class="kd">local</span> <span class="n">shortport</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"shortport"</span>

<span class="c1">-- The Rule Section --</span>
<span class="n">portrule</span> <span class="o">=</span> <span class="n">shortport</span><span class="p">.</span><span class="n">portnumber</span><span class="p">({</span><span class="mi">137</span><span class="p">},</span> <span class="s2">"udp"</span><span class="p">)</span>

<span class="c1">-- The Action Section --</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">nbt_status</span><span class="p">,</span> <span class="n">netbios_name</span> <span class="o">=</span> <span class="n">netbios</span><span class="p">.</span><span class="n">get_server_name</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">netbios_name</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Now run this script against your local network as below:</p>

<p><code class="highlighter-rouge">nmap --script host-discover.nse 10.1.1.0/24 -sU -p 137</code></p>

<p>Now take a minute or two to let this sink in… we just created our very own NETBIOS scanner, all in just 7 lines of functional code. There are dedicated standalone <a href="http://unixwiz.net/tools/nbtscan.html">tools</a> that performs this singular task and we managed to do it using nmap. With just a little more effort, we can add more bells and whistles to this.</p>

<p>The magic that enables this are the excellent inbuilt scanning mechanisms of nmap and hot-pluggable libraries that carry out much of the grunt. By scripting in NSE, we can tap in to this massive capabilities of nmap and automate to our needs. Let us now see how this script works.</p>

<h2 id="code-walkthrough">Code Walkthrough</h2>
<p>In this script there is no HEAD section. So we start by importing the libraries needed for our script. In Lua, modules are included using <code class="highlighter-rouge">require</code> function. And we assign the module to a local variable in order to access its namespace (i.e, call the methods that belong to the module).</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="kd">local</span> <span class="n">netbios</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"netbios"</span>
<span class="kd">local</span> <span class="n">shortport</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"shortport"</span>
</code></pre>
</div>
<p>The purpose of these libraries will be evident in the later section.</p>

<h3 id="rule-section">RULE section</h3>
<p>Next we move to the RULE section. Notice that in Lua, comments are prepended by <code class="highlighter-rouge">--</code> sequence.</p>

<p>As mentioned earlier, RULE section acts as filter to identify hosts or ports relevant to our script. Since our script is only interested with NETBIOS query, we have to pick only the hosts that are listening on port UDP/137.</p>

<p>Since this is a common check, nmap includes a ‘shortport’ module that provides shorthand functions to check port states. <code class="highlighter-rouge">shortport.portnumber</code> is one such function which will return true only for those ports and protocols listed in its arguements. Refer to online <a href="https://nmap.org/nsedoc/lib/shortport.html">documentation</a> for exact syntax of this function.</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="c1">-- The Rule Section --</span>
<span class="n">portrule</span> <span class="o">=</span> <span class="n">shortport</span><span class="p">.</span><span class="n">portnumber</span><span class="p">({</span><span class="mi">137</span><span class="p">},</span> <span class="s2">"udp"</span><span class="p">)</span>
</code></pre>
</div>
<blockquote>
  <p>NOTE: The Rule section only filters port numbers passed on from the upper layer i.e, the original nmap scan. It doesn’t trigger a port scan on its own. That is why when we launch the script, we had to specify port number explicitly (<code class="highlighter-rouge">nmap -sU -p U:137 &lt;host&gt;</code>). It is still possible to launch a port scan in this section, by calling nmap socket libraries but those are advanced scripting scenarios.</p>
</blockquote>

<h3 id="action-section">ACTION Section</h3>
<p>Next comes the ACTION section. Our action section here is a function that takes (host, port) as argument. It means the host object and port object are available to this function for evaluating logic. If we need other variables, they have to be declared outside this function.</p>

<p>Since for NETBIOS query we only need the host our action function will take only ‘host’ as argument. We call the get_server_name function of <a href="https://nmap.org/nsedoc/lib/netbios.html#get_server_name">netbios</a> module. From the documentation we can see that this function returns two values, query status and query result which we capture under two local variables. For our simple task, we need not check the result status and go ahead to return the name variable directly. In Lua, if a variable doesn’t exist it returns nil which is acceptable for our scenario.</p>

<div class="language-lua highlighter-rouge"><pre class="highlight"><code><span class="c1">-- The Action Section --</span>
<span class="n">action</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">nbt_status</span><span class="p">,</span> <span class="n">netbios_name</span> <span class="o">=</span> <span class="n">netbios</span><span class="p">.</span><span class="n">get_server_name</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">netbios_name</span>
<span class="k">end</span>
</code></pre>
</div>
<p>This returned value is processed by nmap scripting engine and printed in the output window.</p>
<blockquote>
  <p>NOTE: In Lua functions are assigned to a variable like how we assign a string or integer value to a variable. In this case, code block defining the ACTION logic is assigned to a variable called action. 
Lua functions are of the format <code class="highlighter-rouge">foo = function ( args ) body end</code>. It can be defined in a single line. To call the function, call the variable with argument such as <code class="highlighter-rouge">foo('bar')</code></p>
</blockquote>

<h2 id="where-to-go-next">Where to go next</h2>
<p>Since this is only a basic script, we have not customized the output format at all. The hostnames when available gets printed below each host-discovered. If you notice, the print action is executed within the ACTION function whose scope is limited to one host at a time. If we need our output to be consolidated in a tabular form, we can write a postrule function, store and retrieve our findings from nmap registry. Refer to my <a href="https://raw.githubusercontent.com/thamizh85/Nmap-scripts/master/hostinfo-discover.nse">script</a> (work in progress) to see one way of doing it.</p>

<p>I strongly recommend to try this <a href="https://thesprawl.org/research/writing-nse-scripts-for-vulnerability-scanning/">walkthrough</a> as well. It greatly helped me to get started with NMAP scripting and understanding the way a NSE script is structured.</p>

<p>It won’t hurt to improve your understanding of Lua programming language as well. I found this 15 minute <a href="http://tylerneylon.com/a/learn-lua/">primer</a> to be very useful.</p>

<p>Lastly the best resource for advanced nmap script writing is the existing script library. There are hundreds of scripts and libraries available, study and explore them to see different ways of tackling a challenge. Good luck scripting!</p>
]]></content>
      <categories>
        
          <category> Scripting </category>
        
      </categories>
      <tags>
        
          <tag> lua </tag>
        
          <tag> nmap </tag>
        
          <tag> network-discovery </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Using a bluetooth serial console with linux]]></title>
      <url>/notes/2017/08/24/using-a-bluetooth-serial-console-with-linux/</url>
      <content type="html"><![CDATA[<p>Recently I bought a <a href="https://www.aliexpress.com/store/product/FREE-SHIPPING-Bt578-rs232-wireless-male-female-general-serial-port-bluetooth-adapter-bluetooth-module/719457_1271204185.html">bluetooth RS232 serial convertor</a>. I wasn’t sure whether it would work with my Linux laptop. But it turned out to be quite simple to setup.</p>

<h2 id="pre-requisites">Pre-requisites</h2>

<p>The following packages are required:</p>
<ul>
  <li>bluez</li>
  <li>bluez-utils</li>
  <li>byobu (optional)</li>
</ul>

<p>Bluez provides the bluetooth protocol stack (most likely shipped with the OS), bluez-utils provides the bluetoothctl utility and byobu is a wrapper around screen terminal emulator. You can also use ‘screen’ directly. Install these using your distributions recommended procedure.</p>

<h2 id="steps">Steps</h2>

<ol>
  <li>Start daemon:
    <div class="language-shell highlighter-rouge"><pre class="highlight"><code> Swanky:~<span class="nv">$ </span>systemctl start bluetooth
</code></pre>
    </div>
  </li>
  <li>Discover using bluetoothctl:
    <div class="language-shell highlighter-rouge"><pre class="highlight"><code> Swanky:~<span class="nv">$ </span>bluetoothctl
 <span class="o">[</span>NEW] Controller &lt;controller-mac-address&gt; xkgt-Swanky <span class="o">[</span>default]
 <span class="o">[</span>bluetooth]# power on
 <span class="o">[</span>bluetooth]# scan on
</code></pre>
    </div>
  </li>
  <li>Once you can see your device, turn off the scan and pair
    <div class="language-shell highlighter-rouge"><pre class="highlight"><code> <span class="o">[</span>bluetooth]# scan off
 <span class="o">[</span>bluetooth]# pair &lt;device-mac-address&gt;
</code></pre>
    </div>
  </li>
  <li>Exit blutoothctl and create serial device (Note that root privileges are required):
    <div class="language-shell highlighter-rouge"><pre class="highlight"><code> <span class="o">[</span>bluetooth]# <span class="nb">exit
 </span>Swanky:~<span class="nv">$ </span>sudo rfcomm <span class="nb">bind </span>0 &lt;device-mac-address&gt;
</code></pre>
    </div>
  </li>
  <li>You should now have /dev/rfcomm0. Connect to it using byobu-screen utility:
    <div class="language-shell highlighter-rouge"><pre class="highlight"><code> Swanky:~<span class="nv">$ </span>byobu-screen /dev/rfcomm0
</code></pre>
    </div>
  </li>
</ol>

<p>Enjoy your wireless console connection!</p>
]]></content>
      <categories>
        
          <category> Notes </category>
        
      </categories>
      <tags>
        
          <tag> bluetooth </tag>
        
          <tag> Linux </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Self-signed certificate chain using OpenSSL X509 module]]></title>
      <url>/notes/sysadmin/2017/08/20/self-signed-certificate-chain-using-openssl-x509-module/</url>
      <content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Generating a self-signed CA certificate or signing a web server certificate using openssl is very easy. There are tons of resources out there in the web. But creating a certificate, which works without any warning on most modern browsers is a challenge. This challenge is compounded by ever-growing stringent requirements from the popular browsers (See footnote 1).</p>

<p>There are two ways to use openssl to mimic a CA. The first option is to use ‘openssl ca’ module, for which there are many guides in the internet. This module mimics a full-fledged CA and useful when you are setting up something for long term requiring features such as CRL and OCSP.</p>

<p>The other option is to use ‘openssl x509’ module which is what we will be focusing on. I chose this because I just needed a certificate pair for one-off use and didn’t want to be bothered in setting up an elaborate CA configuration. The guide will be useful for someone with a similar objective.</p>

<p>As always, let us start with the requirement:</p>
<ol>
  <li>Create a certificate chain with as little configuration and minimum number of hosts, which means no intermediate CA.</li>
  <li>The CA cert would be imported manually in to Trusted Root Authorities on the client machines.</li>
  <li>The certificate should work on modern browsers. We will use latest versions of Chrome and Mozilla as benchmarks.</li>
</ol>

<h2 id="steps">Steps:</h2>

<ol>
  <li>Generate private key &amp; self-signed cert for the CA in a single statement:</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>```bash 
root@EARWA:openssl req -new -x509 -sha256 -newkey rsa:2048 -nodes -keyout ca.key -days 1000 -out ca.pem
root@EARWA:~/ca2# ls -ltr
total 8
-rw-r--r-- 1 root root 1704 Jul 30 20:01 ca.key
-rw-r--r-- 1 root root 1261 Jul 30 20:01 ca.pem
```
</code></pre>
</div>

<blockquote>
  <p>Note: Always use SHA256 as highlighted above. SHA-1 has been deprecated since Jan 2017 (See footnote 2)</p>
</blockquote>

<ol>
  <li>Preparing a config file for CSR: We need to generate a CSR (Certificate Signing Request). This process involves generating a private key and a PEM encoded CSR file. The contents of our Web cert are determined by the information we provide in the CSR.</li>
</ol>

<p>Modern browsers expect a field called sAN(subjectAltName) (See footnote 3). This field should hold all possible URI’s from which our webserver may get accessed.</p>

<p>Since OpenSSL’s default interactive process of CSR generation doesn’t support this field, we need to specify it in a config file and generate the CSR. based on this file Create a config file for Web server request. The highlighted sections are the reason we are using a config file. Otherwise rest of the attributes can be passed interactively.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  root@EARWA:~/ca2# more web.earwa.com.conf
  <span class="o">[</span> subject <span class="o">]</span>
  countryName             <span class="o">=</span> Country Name <span class="o">(</span>2 letter code<span class="o">)</span>
  countryName_default     <span class="o">=</span> HK
  
  organizationName            <span class="o">=</span> Organization Name <span class="o">(</span>eg, company<span class="o">)</span>
  organizationName_default    <span class="o">=</span> Scarlet Spires
  
  basicConstraints    <span class="o">=</span> CA:FALSE
  keyUsage            <span class="o">=</span> digitalSignature, keyEncipherment
  subjectAltName      <span class="o">=</span> @alternate_names
  nsComment           <span class="o">=</span> <span class="s2">"OpenSSL Generated Certificate"</span>
  
  <span class="o">[</span> alternate_names <span class="o">]</span>
  DNS.1       <span class="o">=</span> web.earwa.com
  DNS.2       <span class="o">=</span> www.web.earwa.com
</code></pre>
</div>

<ol>
  <li>Submit a request based on the config file</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  openssl req -config web.earwa.com.conf -new -sha256 -newkey rsa:2048 -nodes -keyout web.earwa.com.key -days 1000 -out web.earwa.com.csr
</code></pre>
</div>

<ol>
  <li>Check the generated request file before signing. You can see our extension fields in the Attributes section</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  root@EARWA:~/ca2# openssl req -in web.earwa.com.csr -text -noout
  

          Attributes:
          Requested Extensions:
              X509v3 Subject Key Identifier:
                  30:47:85:A6:4E:9C:E0:D4:F7:CC:9F:FF:FF:38:03:FC:E7:0E:87:00
              X509v3 Basic Constraints:
                  CA:FALSE
              X509v3 Key Usage:
                  Digital Signature, Key Encipherment
              X509v3 Subject Alternative Name:
                  DNS:web.earwa.com, DNS:www.web.earwa.com
              Netscape Comment:
                  OpenSSL Generated Certificate
  
      Signature Algorithm: sha256WithRSAEncryption
</code></pre>
</div>

<ol>
  <li>This is the portion that tripped me up for a while. Note that earlier I said that the info provided in CSR will be used for certificate generation. It is only partially true, the x509 module cannot copy the extensions info directly from CSR. We need to manually add extensions by using the options -extensions and -extfile. So let us create the V3 extension file first.</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  root@EARWA:~/ca2# more v3.ext
  <span class="o">[</span> v3_req <span class="o">]</span>
  <span class="nv">authorityKeyIdentifier</span><span class="o">=</span>keyid,issuer
  <span class="nv">basicConstraints</span><span class="o">=</span>CA:FALSE
  keyUsage <span class="o">=</span> digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
  subjectAltName      <span class="o">=</span> @alternate_names
  
  
  <span class="o">[</span> alternate_names <span class="o">]</span>
  DNS.1       <span class="o">=</span> web.earwa.com
  DNS.2       <span class="o">=</span> www.web.earwa.com
</code></pre>
</div>

<ol>
  <li>Sign the cert. The highlighted portions refers back to the extension file and the section mentioned above.</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  openssl x509 -extensions v3_req -extfile v3.ext -req -sha256 -days 1000 -in web.earwa.com.csr -CA ca.pem -CAcreateserial -CAkey ca.key -out web.earwa.com.pem
</code></pre>
</div>

<ol>
  <li>Verify the cert</li>
</ol>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  root@EARWA:~/ca2# openssl x509 -in web.earwa.com.pem -text -noout
  
  Certificate:
      Data:
          Version: 3 <span class="o">(</span>0x2<span class="o">)</span>
          Serial Number: 14178612693219512833 <span class="o">(</span>0xc4c48d1f7b319201<span class="o">)</span>
      Signature Algorithm: sha256WithRSAEncryption
          Issuer: <span class="nv">C</span><span class="o">=</span>HK, <span class="nv">ST</span><span class="o">=</span>Some-State, <span class="nv">O</span><span class="o">=</span>Scarlet Spires
          Validity
              Not Before: Jul 31 16:36:03 2017 GMT
              Not After : Apr 26 16:36:03 2020 GMT
          Subject: <span class="nv">C</span><span class="o">=</span>HK, <span class="nv">O</span><span class="o">=</span>Scarlet Spires
          Subject Public Key Info:
              Public Key Algorithm: rsaEncryption
                  Public-Key: <span class="o">(</span>2048 bit<span class="o">)</span>
                 Modulus:
                      00:c6:f9:32:79:11:20:ff:97:da:38:a0:61:b9:41:
                      1f:51:c0:1f:a1:48:05:74:54:81:23:9b:22:24:8d:
                      35:f2:25:83:15:f2:9b:30:a5:43:2d:4d:08:2f:c7:
                      9e:42:1d:f7:66:68:07:8f:da:0b:f9:5c:51:97:b1:
                      0e:dc:44:d1:a4:5c:a1:ef:35:43:84:52:99:34:9f:
                      7d:41:54:9f:65:21:4c:1c:21:6f:9c:73:d5:f2:3d:
                      3c:6d:da:fe:85:88:98:4d:02:42:52:ea:9c:61:fe:
                      e7:bc:c2:d6:44:9d:9f:f6:3d:cb:32:c6:e4:8d:d1:
                      74:47:80:87:ac:8d:8a:64:8a:4e:54:ce:54:4e:75:
                      3a:85:af:f5:96:9b:5f:a0:a0:6d:27:06:1c:8d:0b:
                      4b:c5:1e:15:ff:16:4a:87:1e:9b:cc:98:a9:c5:8f:
                      4f:f1:19:28:cd:90:6c:85:ab:58:37:14:d6:58:cb:
                      7d:ab:8b:34:62:2a:72:b4:17:96:0b:6f:84:31:54:
                      55:aa:06:56:00:04:5e:2d:d1:14:fa:7f:2d:b3:44:
                      d3:1d:95:c2:93:ec:4e:17:e8:30:fa:e7:f5:be:b1:
                      5f:9a:59:59:ac:0d:b7:04:4a:19:35:a2:a5:44:64:
                      d4:a0:93:f8:dc:9f:3a:20:7b:5c:d7:26:67:28:67:
                      87:73
                  Exponent: 65537 <span class="o">(</span>0x10001<span class="o">)</span>
          X509v3 extensions:
              X509v3 Authority Key Identifier:
                  keyid:32:33:41:52:11:5A:AE:F9:89:4E:8E:EE:26:E3:D2:7D:CA:C9:BC:63
  
               X509v3 Basic Constraints:
                  CA:FALSE
              X509v3 Key Usage:
                 Digital Signature, Non Repudiation, Key Encipherment, Data Encipherment
              X509v3 Subject Alternative Name:
                  DNS:web.earwa.com, DNS:www.web.earwa.com
      Signature Algorithm: sha256WithRSAEncryption
           59:d5:45:b3:ca:60:32:a8:37:85:3b:bf:6f:d1:b3:26:f6:4b:
           f2:26:2c:68:6f:cb:5c:3b:a8:6f:a9:32:53:71:98:74:26:be:
           4f:3e:a9:13:e6:ba:e4:3e:52:83:86:0d:9d:53:4a:1e:e8:a5:
            94:36:bf:c2:17:62:b9:8e:87:8d:32:f1:34:1a:e3:81:6b:0b:
           5a:b7:a8:55:c4:24:ca:b2:65:75:e2:4b:ac:c4:9b:9e:d1:94:
           45:31:92:1d:6b:30:6c:29:03:fd:1e:49:8e:8e:d5:30:6f:68:
           <span class="nb">fc</span>:01:82:f8:57:83:85:47:15:e9:78:96:39:86:94:cb:96:29:
           5b:61:f0:d9:23:d1:25:ca:a0:ea:80:ce:42:bb:12:40:b9:64:
           c6:a5:4f:99:dc:f3:26:74:49:bc:b2:70:49:d2:22:f2:75:07:
           6e:8f:96:9b:e6:67:ad:21:01:23:57:46:ea:78:12:3b:c8:ba:
           dc:ae:39:ee:d6:30:6d:58:ab:f0:fe:c1:68:fb:0a:68:09:fc:
           93:28:84:27:2d:1d:c0:c2:06:53:1b:3b:ff:ec:d8:a1:90:1c:
           c4:59:c0:c3:d5:f4:bb:d4:79:35:dd:7f:05:60:3f:a9:ba:b0:
            5c:b3:66:13:03:4f:ac:31:0c:8a:e9:82:8d:36:c1:78:bf:d6:
           5e:6d:f9:13
</code></pre>
</div>

<p>That is it! Now you have a web server cert which would be trusted by most browsers, provided you import the root CA public cert in to the browsers’ trust chain.</p>

<h4 id="footnote-1">Footnote #1</h4>

<p><a href="https://cabforum.org/baseline-requirements-documents/">https://cabforum.org/baseline-requirements-documents/</a></p>

<h4 id="footnote-2">Footnote #2</h4>

<p>SHA-1 disabled on Chrome 56 and FireFox (Jan 2017)</p>

<p><a href="https://www.chromestatus.com/features/6601657605423104">https://www.chromestatus.com/features/6601657605423104</a></p>

<p><a href="https://sites.google.com/a/chromium.org/dev/Home/chromium-security/education/tls/sha-1">https://sites.google.com/a/chromium.org/dev/Home/chromium-security/education/tls/sha-1</a></p>

<p><a href="https://blog.mozilla.org/security/2017/02/23/the-end-of-sha-1-on-the-public-web/">https://blog.mozilla.org/security/2017/02/23/the-end-of-sha-1-on-the-public-web/</a></p>

<h4 id="footnote-3">Footnote #3</h4>

<p>SAN mandatory</p>

<p><a href="https://www.chromestatus.com/features/4981025180483584">https://www.chromestatus.com/features/4981025180483584</a></p>

<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1245280">https://bugzilla.mozilla.org/show_bug.cgi?id=1245280</a></p>

<p><a href="https://tools.ietf.org/html/rfc2818">https://tools.ietf.org/html/rfc2818</a></p>
]]></content>
      <categories>
        
          <category> Notes </category>
        
          <category> SysAdmin </category>
        
      </categories>
      <tags>
        
          <tag> openssl </tag>
        
          <tag> pki </tag>
        
          <tag> web </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
    <entry>
      <title><![CDATA[Dynamic registration of DNS for Linux devices in an Active Directory environment with Windows DNS server]]></title>
      <url>/sysadmin/2017/07/19/dynamic-registration-of-dns-for-linux-devices-in-an-active-directory-environment-with-windows-dns-server/</url>
      <content type="html"><![CDATA[<p>While Linux has proliferated extensively in the server arena in the recent past, client networks are still dominated by Windows devices. This means, things that we take for granted in a client environment such as DDNS are not as matured as they are in Windows environment. One may ask whether the recent surge in Linux based clients such as IoT devices has changed this equation. But the nature of these devices is different from Windows based clients that they mostly rely on outbound connection to internet. Since they seldom require other hosts to initiate connection to them, their operation doesn’t rely much on Dynamic DNS.</p>

<p>So, what does it take to make a Linux client register dynamically in a Windows environment? At its basic, the entire process relies on Dynamic DNS as explained in <a href="https://tools.ietf.org/html/rfc2136">RFC2136</a>. In a traditional windows environment with AD, this process is taken care by client OS. Every time a Windows PC gets an IP address from DHCP server, it would send a DNS Update (Opcode = 5) request to its registered DNS server. Performed manually, this is same as typing “ipconfig /registerdns” at an elevated command prompt. This behaviour can be modified by accessing DNS section of Advanced TCP/IP settings of a network adapter.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/1-dns-properties.png" alt="1 - DNS Properties.png" /></p>

<p>When we ask a Linux client to do the same (later I will explain how it can be configured to ask), it won’t work unless the DNS server is configured to accept “Insecure updates” (Which is a major security risk if you need to ask).</p>

<p>Take a look at the capture of Linux client performing DNS update, you can see that the server comes back with a UPDATE REFUSED response.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/2-linux-dns-update-capture.png" alt="2 - Linux DNS Update Capture.png" /></p>

<p>This is because our DNS server is enabled with secure updates which means only authenticated clients can send update.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/3-dns-secure-updates-option.png" alt="3 - DNS Secure Updates option.png" /></p>

<p>The client is expected to send a transaction signature along with the update request. There are different types of signatures such as a TSIG resource or the SIG(0) or GSS-TSIG signatures. In Windows world however, only GSS-TSIG signatures as described in <a href="https://tools.ietf.org/html/rfc3645">RFC3645</a> are understood and accepted.</p>

<p>Looking at a capture from a Windows PC joined to domain, one can see the Windows Device sending Update request with GSS-TSIG resource.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/2-windows-dns-update-capture.png" alt="2 - Windows DNS Update Capture.png" /></p>

<p>Given this background, let us explore some of the options available to setup DDNS for Linux based clients. In this series of posts, I will explore 3 options:</p>
<ol>
  <li>Configure DHCP server to perform DNS registration on behalf of the clients</li>
  <li>Join the Linux devices to AD domain and configure them to dynamically update</li>
  <li>Setup a new sub-domain running a dedicated Linux BIND server and configure DNS forwarding on Microsoft DNS server.</li>
</ol>

<p>Our environment has the following setup:</p>
<ol>
  <li>Microsoft Active Directory environment with DNS server installed in Domain controller and a DHCP server running separately on a different host. All are running on Windows Server 2008 R2.</li>
  <li>DNS is configured to accept only Secure updates.</li>
  <li>Two Linux devices running Debian Stretch operating system. One of them will act as DNS server in one of the scenarios.</li>
</ol>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/4-lab-topology.png" alt="4 - Lab Topology.png" /></p>

<p>The solutions we discuss should meet the following objectives:</p>
<ol>
  <li>Update DNS when the device gets an IP address</li>
  <li>Perform periodic update to DNS server to protect against expiry</li>
  <li>Fully automated with very little or no hand-coding on client devices, assume no automation tools like Puppet or Chef</li>
  <li>Scalable to hundreds or thousands of devices</li>
</ol>

<p>Point 3 is important to me since I had to work out a solution at work where we are using hundreds of Raspberry Pi’s, all booting the same image cloned on to flash disks. So, editing config files on each of them is not an option (we will come to this later).</p>

<hr />

<h2 id="configuring-dhcp-server-to-perform-dns-registration-on-behalf-of-the-clients">Configuring DHCP server to perform DNS registration on behalf of the clients</h2>

<p>This is the simplest and most reliable solution of the available options. This method makes use of DHCP option 81 as defined in <a href="https://tools.ietf.org/html/rfc4702">RFC4702</a>, which is used to convey a client’s FQDN to a DHCP server as part of DHCP process.</p>

<blockquote>An aside: RFC doesn’t mandate whether a DHCP server should register client’s DNS or not. It is left to site-specific policies, which may differ per the security context of the site.</blockquote>

<p>The default setting in a Microsoft DHCP server scope is as follows (Right click on scope name -&gt; Properties to reach here):</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/5-default-scope-properties.png" alt="5 - Default scope properties.png" /></p>

<p>Understandably, this only updates to DNS server if requested by the client. What happens if we select the option to “Always dynamically update DNS A and PTR records”? Is that what we want?</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/6-always-dynamically-update1.png" alt="6 - Always dynamically update.png" /></p>

<p>If you trigger a DHCP request from the client, you will notice that this doesn’t work.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/7-no-dns-update.png" alt="7 - No DNS Update.png" /></p>

<p>This setting merely controls whether a DHCP server should update ‘A’ record or not.  The label “Always dynamically update DNS A and PTR records” is misleading since it applies only for the clients that request a DNS update. By default, a client is responsible for updating the A record and DHCP server is responsible for updating the PTR record. Selecting the second option forces DHCP server to update A record as well. But the prerequisite is that the client should request for DNS update.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/8-dns-update-options.png" alt="8 - DNS Update options.png" /></p>

<p>The two options above correspond to the two cases discussed in <a href="https://tools.ietf.org/html/rfc4702">RFC4702</a></p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/9-rfc-4702.png" alt="9 - RFC 4702.png" /></p>

<p>For our Linux clients, the option we need is the last check box. Let us turn this on and trigger a DHCP request from our client.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/10-dynamically-update-for-linux-clients.png" alt="10 - Dynamically update for Linux clients.png" /></p>

<p>When we check the DNS server, we can see that the A record successfully is created.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/11-successful-registration.png" alt="11 - Successful Registration.png" /></p>

<p>On the capture, we can see secure DNS update message being sent from the DHCP server (Note that the DNS clients always tries insecure updates first and gets rejected by the server).</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/12-successful-registration-packets.png" alt="12 - Successful Registration Packets.png" /></p>

<p>For a home environment, this is almost enough. But for production environments, with multiple DHCP servers, this is not enough. The problem is that, in such setup the DHCP server becomes the owner of the A and PTR records (see below). It is fine as long as the DHCP server is alive to create and remove records. But when it goes down, its peer DHCP server won’t be able to do anything about those records.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/13-a-record-owner.png" alt="13 - A record owner.png" /></p>

<p>This <a href="https://technet.microsoft.com/en-us/library/dd334715(v=ws.10).aspx">link</a> explains the issue in more detail. Let us follow the advice, create a dedicated user account for updating DNS and delete the old record with DHCP server as owner. Do not grant any extra privilege to this account. Just adding to DNSUpdateProxy group should be sufficient (Right click on IPv4 -&gt; Properties -&gt; Advanced).</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/14-dynamic-update-credentials.png" alt="14 - Dynamic update credentials.png" /></p>

<p>As usual, let us go ahead to trigger an update.</p>

<p><img src="/images/2017-07-19-dynamic-registration-of-dns-for-linux-devices-in-an-active-directory-environment-with-windows-dns-server/15-dhcp-request.png" alt="15 - DHCP Request.png" /></p>

<p>As expected, new A and PTR record gets created.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/16-successful-registration.png" alt="16 - Successful Registration.png" /></p>

<p>If we check the ownership, we can find that the record is owned by DNSProxyUpdate group.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/16-dynamic-update-credentials1.png" alt="16 - Dynamic update credentials.png" /></p>

<hr />

<p>Finally, let us discuss the option called “Name Protection” at the bottom of the dialog box.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/17-name-protection.png" alt="17 - Name Protection.png" /></p>

<p>This forces DHCP server to manage the entire lifecycle of your client’s A and PTR records. If you are going to let your DHCP server manage client’s A record, I don’t see any reason to keep this disabled. It will also protect you from “<a href="https://technet.microsoft.com/en-us/library/dd759188(v=ws.11).aspx">Name Squatting</a>” by offline clients. <a href="https://tools.ietf.org/html/rfc4701">RFC4701 </a>describes the problem as:</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/18-rfc4701.png" alt="18 - RFC4701.png" /></p>

<p>Let us see what it means to turn on this option. First, we keep it disabled and bring two clients online with same hostname, one after other. All is well when the first client comes online and gets an IP address 192.168.179.50.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/19-dhcp-request.png" alt="19 - DHCP Request.png" /></p>

<p>DNS also gets updated accordingly.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/20-dns-update.png" alt="20 - DNS Update.png" /></p>

<p>Let us bring another Linux client online and change the hostname to same as this host. Then perform a DHCP request from this host.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/21-hostname-change.png" alt="21 - Hostname change.png" /></p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/22-dhcp-request.png" alt="22 - DHCP Request.png" /></p>

<p>DHCP server assigns IP address 192.168.179.51 and sends an update to DNS server. Note that the DHCP server makes no fuss about two hosts sharing the same hostname. For all it knows, it could be the same host with multiple interfaces.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/23-dhcp-update.png" alt="23 - DHCP Update.png" /></p>

<p>On the DNS sever side, we see that it accepts this update without any hesitation. The only problem is that this overwrites the existing record, while the client is still online. So, anyone trying to talk the first node ends up talking to the second node.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/24-dns-overwritten.png" alt="24 - DNS overwritten.png" /></p>

<p>Clearly, DHCP server is not a reliable source of identity. RFC4703 briefly mentions the inability of DHCP server to provide any sort of assurance.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/25-rfc4703.png" alt="25 - RFC4703.png" /></p>

<p>Let us see what happens when we enable “Name Protection”.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/26-enable-name-protection.png" alt="26 - Enable Name Protection.png" /></p>

<p>As soon as we enable this option, first thing we notice is that all other options are greyed out. This is because, with Name Protection enabled, it is always the responsibility of DHCP server to perform both A record and PTR record updates.</p>

<p>Let us wipe the slate clean, by releasing IP address from both the clients and deleting the existing DNS &amp; DHCP records.</p>

<p>Now when you bring the first Linux client online, you can see that the DHCP server performs a new type of record registration called DHCID.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/27-successful-dhcid-capture.png" alt="27 - Successful DHCID Capture.png" /></p>

<p>A new record type DHCID appears in the DNS server.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/28-successful-dhcid-registered.png" alt="28 - Successful DHCID registered.png" /></p>

<p>Let us bring up the impostor and request DHCP address. It gets an IP address of 192.168.179.51.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/29-dns-impersonation.png" alt="29 - DNS Impersonation.png" /></p>

<p>As usual, DHCP server is very generous about having two hosts sharing the same hostname.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/30-duplicate-dhcp-update.png" alt="30 - Duplicate DHCP Update.png" /></p>

<p>But no new DNS entry is created.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/31-name-protection-success.png" alt="31 - Name protection success.png" /></p>

<p>Looking at the capture, we can see that the DNS registration fails with a response that RRset does not exist.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/32-dns-update-refused-capture.png" alt="32 - DNS Update refused capture.png" /></p>

<p>This message means that DHCID value calculated from the new update packet doesn’t match with any DHCID RR’s stored in the server. This behaviour is described in <a href="https://tools.ietf.org/html/rfc4701">RFC4701</a>.</p>

<p><img src="https://ephemeralelectrons.files.wordpress.com/2017/07/33-rfc4701.png" alt="33 - RFC4701.png" /></p>

<p>This is as much as we need to know about configuring a Microsoft DHCP server to perform Dynamic DNS for Linux clients. In the upcoming posts, let us explore the other two options.</p>
]]></content>
      <categories>
        
          <category> SysAdmin </category>
        
      </categories>
      <tags>
        
          <tag> DHCP </tag>
        
          <tag> DNS </tag>
        
          <tag> Dynamic DNS </tag>
        
          <tag> Linux </tag>
        
      </tags>
      <tags></tags>
    </entry>
  
</search>
